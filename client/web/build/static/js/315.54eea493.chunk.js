"use strict";(self.webpackChunkrealchar=self.webpackChunkrealchar||[]).push([[315],{1315:function(e,t,i){i.r(t),i.d(t,{FileFilter:function(){return Li},Live2DAvatarLoader:function(){return Fi},extractModelFileName:function(){return Ei},fillInRelativePath:function(){return Ti}});var r,n,a,s,o=i(5671),u=i(3144),l=i(4165),h=i(5861),c=(i(8467),i(9439)),d=i(7326),f=i(1752),g=i(1120),m=i(8737),p=i(7762),v=i(3433),_=i(136),y=i(7277),x=i(7396),k=i(8166),M=i(9150),b=i(4574),P=Math.pow,S=function(e,t,i){return new Promise((function(r,n){var a=function(e){try{o(i.next(e))}catch(t){n(t)}},s=function(e){try{o(i.throw(e))}catch(t){n(t)}},o=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(a,s)};o((i=i.apply(e,t)).next())}))};(n=r||(r={})).supportMoreMaskDivisions=!0,n.setOpacityFromMotion=!1,(s=a||(a={})).LOG_LEVEL_VERBOSE=0,s.LOG_LEVEL_WARNING=1,s.LOG_LEVEL_ERROR=2,s.LOG_LEVEL_NONE=999,s.logLevel=s.LOG_LEVEL_WARNING,s.sound=!0,s.motionSync=!0,s.motionFadingDuration=500,s.idleMotionFadingDuration=2e3,s.expressionFadingDuration=500,s.preserveExpressionOnMotion=!0,s.cubism4=r;var C=function(e){if(a.logLevel<=a.LOG_LEVEL_VERBOSE){for(var t,i=arguments.length,r=new Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];(t=console).log.apply(t,["[".concat(e,"]")].concat(r))}},w=function(e){if(a.logLevel<=a.LOG_LEVEL_WARNING){for(var t,i=arguments.length,r=new Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];(t=console).warn.apply(t,["[".concat(e,"]")].concat(r))}};function I(e,t,i){return e<t?t:e>i?i:e}function L(e,t,i,r,n){var a=t[r];null!==a&&typeof a===e&&(i[n]=a)}function T(e,t,i,r,n){var a=t[r];Array.isArray(a)&&(i[n]=a.filter((function(t){return null!==t&&typeof t===e})))}function E(e,t){t.forEach((function(t){Object.getOwnPropertyNames(t.prototype).forEach((function(i){"constructor"!==i&&Object.defineProperty(e.prototype,i,Object.getOwnPropertyDescriptor(t.prototype,i))}))}))}var F=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r){var n;return(0,o.Z)(this,i),(n=t.call(this)).expressions=[],n.reserveExpressionIndex=-1,n.destroyed=!1,n.settings=e,n.tag="ExpressionManager(".concat(e.name,")"),n}return(0,u.Z)(i,[{key:"init",value:function(){this.defaultExpression=this.createExpression({},void 0),this.currentExpression=this.defaultExpression,this.stopAllExpressions()}},{key:"loadExpression",value:function(e){return S(this,null,(0,l.Z)().mark((function t(){var i;return(0,l.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.definitions[e]){t.next=3;break}return w(this.tag,"Undefined expression at [".concat(e,"]")),t.abrupt("return",void 0);case 3:if(null!==this.expressions[e]){t.next=6;break}return w(this.tag,"Cannot set expression at [".concat(e,"] because it's already failed in loading.")),t.abrupt("return",void 0);case 6:if(!this.expressions[e]){t.next=8;break}return t.abrupt("return",this.expressions[e]);case 8:return t.next=10,this._loadExpression(e);case 10:return i=t.sent,this.expressions[e]=i,t.abrupt("return",i);case 13:case"end":return t.stop()}}),t,this)})))}},{key:"_loadExpression",value:function(e){throw new Error("Not implemented.")}},{key:"setRandomExpression",value:function(){return S(this,null,(0,l.Z)().mark((function e(){var t,i,r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.definitions.length){e.next=6;break}for(t=[],i=0;i<this.definitions.length;i++)null!==this.expressions[i]&&this.expressions[i]!==this.currentExpression&&i!==this.reserveExpressionIndex&&t.push(i);if(!t.length){e.next=6;break}return r=Math.floor(Math.random()*t.length),e.abrupt("return",this.setExpression(r));case 6:return e.abrupt("return",!1);case 7:case"end":return e.stop()}}),e,this)})))}},{key:"resetExpression",value:function(){this._setExpression(this.defaultExpression)}},{key:"restoreExpression",value:function(){this._setExpression(this.currentExpression)}},{key:"setExpression",value:function(e){return S(this,null,(0,l.Z)().mark((function t(){var i;return(0,l.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("number"!==typeof e&&(e=this.getExpressionIndex(e)),e>-1&&e<this.definitions.length){t.next=3;break}return t.abrupt("return",!1);case 3:if(e!==this.expressions.indexOf(this.currentExpression)){t.next=5;break}return t.abrupt("return",!1);case 5:return this.reserveExpressionIndex=e,t.next=8,this.loadExpression(e);case 8:if((i=t.sent)&&this.reserveExpressionIndex===e){t.next=11;break}return t.abrupt("return",!1);case 11:return this.reserveExpressionIndex=-1,this.currentExpression=i,this._setExpression(i),t.abrupt("return",!0);case 15:case"end":return t.stop()}}),t,this)})))}},{key:"update",value:function(e,t){return!this.isFinished()&&this.updateParameters(e,t)}},{key:"destroy",value:function(){this.destroyed=!0,this.emit("destroy");this.definitions=void 0,this.expressions=void 0}}]),i}(x.EventEmitter),D=function(){function e(){(0,o.Z)(this,e),this.targetX=0,this.targetY=0,this.x=0,this.y=0,this.vx=0,this.vy=0}return(0,u.Z)(e,[{key:"focus",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.targetX=I(e,-1,1),this.targetY=I(t,-1,1),i&&(this.x=this.targetX,this.y=this.targetY)}},{key:"update",value:function(e){var t=this.targetX-this.x,i=this.targetY-this.y;if(!(Math.abs(t)<.01&&Math.abs(i)<.01)){var r=Math.sqrt(P(t,2)+P(i,2)),n=5.333333333333333/(1e3/e),a=n*(t/r)-this.vx,s=n*(i/r)-this.vy,o=Math.sqrt(P(a,2)+P(s,2)),u=.006666666666666667*n*e;o>u&&(a*=u/o,s*=u/o),this.vx+=a,this.vy+=s;var l=Math.sqrt(P(this.vx,2)+P(this.vy,2)),h=.5*(Math.sqrt(P(u,2)+8*u*r)-u);l>h&&(this.vx*=h/l,this.vy*=h/l),this.x+=this.vx,this.y+=this.vy}}}]),e}(),A=function(){function e(t){(0,o.Z)(this,e),this.json=t;var i=t.url;if("string"!==typeof i)throw new TypeError("The `url` field in settings JSON must be defined as a string.");this.url=i,this.name=function(e){var t=e.lastIndexOf("/");return-1!=t&&(e=e.slice(0,t)),-1!==(t=e.lastIndexOf("/"))&&(e=e.slice(t+1)),e}(this.url)}return(0,u.Z)(e,[{key:"resolveURL",value:function(e){return x.url.resolve(this.url,e)}},{key:"replaceFiles",value:function(e){this.moc=e(this.moc,"moc"),void 0!==this.pose&&(this.pose=e(this.pose,"pose")),void 0!==this.physics&&(this.physics=e(this.physics,"physics"));for(var t=0;t<this.textures.length;t++)this.textures[t]=e(this.textures[t],"textures[".concat(t,"]"))}},{key:"getDefinedFiles",value:function(){var e=[];return this.replaceFiles((function(t){return e.push(t),t})),e}},{key:"validateFiles",value:function(e){var t=this,i=function(i,r){var n=t.resolveURL(i);if(!e.includes(n)){if(r)throw new Error('File "'.concat(i,"\" is defined in settings, but doesn't exist in given files"));return!1}return!0};return[this.moc].concat((0,v.Z)(this.textures)).forEach((function(e){return i(e,!0)})),this.getDefinedFiles().filter((function(e){return i(e,!1)}))}}]),e}(),R=function(e){return e[e.NONE=0]="NONE",e[e.IDLE=1]="IDLE",e[e.NORMAL=2]="NORMAL",e[e.FORCE=3]="FORCE",e}(R||{}),B=function(){function e(){(0,o.Z)(this,e),this.debug=!1,this.currentPriority=0,this.reservePriority=0}return(0,u.Z)(e,[{key:"reserve",value:function(e,t,i){if(i<=0)return C(this.tag,"Cannot start a motion with MotionPriority.NONE."),!1;if(e===this.currentGroup&&t===this.currentIndex)return C(this.tag,"Motion is already playing.",this.dump(e,t)),!1;if(e===this.reservedGroup&&t===this.reservedIndex||e===this.reservedIdleGroup&&t===this.reservedIdleIndex)return C(this.tag,"Motion is already reserved.",this.dump(e,t)),!1;if(1===i){if(0!==this.currentPriority)return C(this.tag,"Cannot start idle motion because another motion is playing.",this.dump(e,t)),!1;if(void 0!==this.reservedIdleGroup)return C(this.tag,"Cannot start idle motion because another idle motion has reserved.",this.dump(e,t)),!1;this.setReservedIdle(e,t)}else{if(i<3){if(i<=this.currentPriority)return C(this.tag,"Cannot start motion because another motion is playing as an equivalent or higher priority.",this.dump(e,t)),!1;if(i<=this.reservePriority)return C(this.tag,"Cannot start motion because another motion has reserved as an equivalent or higher priority.",this.dump(e,t)),!1}this.setReserved(e,t,i)}return!0}},{key:"start",value:function(e,t,i,r){if(1===r){if(this.setReservedIdle(void 0,void 0),0!==this.currentPriority)return C(this.tag,"Cannot start idle motion because another motion is playing.",this.dump(t,i)),!1}else{if(t!==this.reservedGroup||i!==this.reservedIndex)return C(this.tag,"Cannot start motion because another motion has taken the place.",this.dump(t,i)),!1;this.setReserved(void 0,void 0,0)}return!!e&&(this.setCurrent(t,i,r),!0)}},{key:"complete",value:function(){this.setCurrent(void 0,void 0,0)}},{key:"setCurrent",value:function(e,t,i){this.currentPriority=i,this.currentGroup=e,this.currentIndex=t}},{key:"setReserved",value:function(e,t,i){this.reservePriority=i,this.reservedGroup=e,this.reservedIndex=t}},{key:"setReservedIdle",value:function(e,t){this.reservedIdleGroup=e,this.reservedIdleIndex=t}},{key:"isActive",value:function(e,t){return e===this.currentGroup&&t===this.currentIndex||e===this.reservedGroup&&t===this.reservedIndex||e===this.reservedIdleGroup&&t===this.reservedIdleIndex}},{key:"reset",value:function(){this.setCurrent(void 0,void 0,0),this.setReserved(void 0,void 0,0),this.setReservedIdle(void 0,void 0)}},{key:"shouldRequestIdleMotion",value:function(){return void 0===this.currentGroup&&void 0===this.reservedIdleGroup}},{key:"shouldOverrideExpression",value:function(){return!a.preserveExpressionOnMotion&&this.currentPriority>1}},{key:"dump",value:function(e,t){var i=this;if(this.debug){return'\n<Requested> group = "'.concat(e,'", index = ').concat(t,"\n")+["currentPriority","reservePriority","currentGroup","currentIndex","reservedGroup","reservedIndex","reservedIdleGroup","reservedIdleIndex"].map((function(e){return"["+e+"] "+i[e]})).join("\n")}return""}}]),e}(),O=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"volume",get:function(){return this._volume},set:function(e){var t=this;this._volume=(e>1?1:e<0?0:e)||0,this.audios.forEach((function(e){return e.volume=t._volume}))}},{key:"add",value:function(e,t,i){var r=this,n=new Audio(e);return n.volume=this._volume,n.preload="auto",n.addEventListener("ended",(function(){r.dispose(n),null==t||t()})),n.addEventListener("error",(function(t){r.dispose(n),w("SoundManager",'Error occurred on "'.concat(e,'"'),t.error),null==i||i(t.error)})),this.audios.push(n),n}},{key:"play",value:function(e){return new Promise((function(t,i){var r;null==(r=e.play())||r.catch((function(t){e.dispatchEvent(new ErrorEvent("error",{error:t})),i(t)})),e.readyState===e.HAVE_ENOUGH_DATA?t():e.addEventListener("canplaythrough",t)}))}},{key:"dispose",value:function(e){e.pause(),e.removeAttribute("src"),function(e,t){var i=e.indexOf(t);-1!==i&&e.splice(i,1)}(this.audios,e)}},{key:"destroy",value:function(){for(var e=this.audios.length-1;e>=0;e--)this.dispose(this.audios[e])}}]),e}();O.audios=[],O._volume=.5;var Z=function(e){return e.ALL="ALL",e.IDLE="IDLE",e.NONE="NONE",e}(Z||{}),U=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r){var n;return(0,o.Z)(this,i),(n=t.call(this)).motionGroups={},n.state=new B,n.playing=!1,n.destroyed=!1,n.settings=e,n.tag="MotionManager(".concat(e.name,")"),n.state.tag=n.tag,n}return(0,u.Z)(i,[{key:"init",value:function(e){(null==e?void 0:e.idleMotionGroup)&&(this.groups.idle=e.idleMotionGroup),this.setupMotions(e),this.stopAllMotions()}},{key:"setupMotions",value:function(e){for(var t=0,i=Object.keys(this.definitions);t<i.length;t++){var r=i[t];this.motionGroups[r]=[]}var n;switch(null==e?void 0:e.motionPreload){case"NONE":return;case"ALL":n=Object.keys(this.definitions);break;default:n=[this.groups.idle]}var a,s=(0,p.Z)(n);try{for(s.s();!(a=s.n()).done;){var o=a.value;if(this.definitions[o])for(var u=0;u<this.definitions[o].length;u++)this.loadMotion(o,u).then()}}catch(l){s.e(l)}finally{s.f()}}},{key:"loadMotion",value:function(e,t){return S(this,null,(0,l.Z)().mark((function i(){var r,n;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(null==(r=this.definitions[e])?void 0:r[t]){i.next=3;break}return w(this.tag,'Undefined motion at "'.concat(e,'"[').concat(t,"]")),i.abrupt("return",void 0);case 3:if(null!==this.motionGroups[e][t]){i.next=6;break}return w(this.tag,'Cannot start motion at "'.concat(e,'"[').concat(t,"] because it's already failed in loading.")),i.abrupt("return",void 0);case 6:if(!this.motionGroups[e][t]){i.next=8;break}return i.abrupt("return",this.motionGroups[e][t]);case 8:return i.next=10,this._loadMotion(e,t);case 10:if(n=i.sent,!this.destroyed){i.next=13;break}return i.abrupt("return");case 13:return this.motionGroups[e][t]=null!=n?n:null,i.abrupt("return",n);case 15:case"end":return i.stop()}}),i,this)})))}},{key:"_loadMotion",value:function(e,t){throw new Error("Not implemented.")}},{key:"startMotion",value:function(e,t){return S(this,arguments,(function(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:R.NORMAL;return(0,l.Z)().mark((function n(){var s,o,u,h,c,d;return(0,l.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(i.state.reserve(e,t,r)){n.next=2;break}return n.abrupt("return",!1);case 2:if(o=null==(s=i.definitions[e])?void 0:s[t]){n.next=5;break}return n.abrupt("return",!1);case 5:if(i.currentAudio&&O.dispose(i.currentAudio),a.sound&&(h=i.getSoundFile(o)))try{u=O.add(i.settings.resolveURL(h),(function(){return i.currentAudio=void 0}),(function(){return i.currentAudio=void 0})),i.currentAudio=u}catch(l){w(i.tag,"Failed to create audio",h,l)}return n.next=9,i.loadMotion(e,t);case 9:if(c=n.sent,!u){n.next=15;break}if(d=O.play(u).catch((function(e){return w(i.tag,"Failed to play audio",u.src,e)})),!a.motionSync){n.next=15;break}return n.next=15,d;case 15:if(i.state.start(c,e,t,r)){n.next=18;break}return u&&(O.dispose(u),i.currentAudio=void 0),n.abrupt("return",!1);case 18:return C(i.tag,"Start motion:",i.getMotionName(o)),i.emit("motionStart",e,t,u),i.state.shouldOverrideExpression()&&i.expressionManager&&i.expressionManager.resetExpression(),i.playing=!0,i._startMotion(c),n.abrupt("return",!0);case 24:case"end":return n.stop()}}),n)}))()}))}},{key:"startRandomMotion",value:function(e,t){return S(this,null,(0,l.Z)().mark((function i(){var r,n,a,s;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!(null==(r=this.definitions[e])?void 0:r.length)){i.next=7;break}for(n=[],a=0;a<r.length;a++)null===this.motionGroups[e][a]||this.state.isActive(e,a)||n.push(a);if(!n.length){i.next=7;break}return s=Math.floor(Math.random()*n.length),i.abrupt("return",this.startMotion(e,n[s],t));case 7:return i.abrupt("return",!1);case 8:case"end":return i.stop()}}),i,this)})))}},{key:"stopAllMotions",value:function(){this._stopAllMotions(),this.state.reset(),this.currentAudio&&(O.dispose(this.currentAudio),this.currentAudio=void 0)}},{key:"update",value:function(e,t){var i;return this.isFinished()&&(this.playing&&(this.playing=!1,this.emit("motionFinish")),this.state.shouldOverrideExpression()&&(null==(i=this.expressionManager)||i.restoreExpression()),this.state.complete(),this.state.shouldRequestIdleMotion()&&this.startRandomMotion(this.groups.idle,R.IDLE)),this.updateParameters(e,t)}},{key:"destroy",value:function(){var e;this.destroyed=!0,this.emit("destroy"),this.stopAllMotions(),null==(e=this.expressionManager)||e.destroy();this.definitions=void 0,this.motionGroups=void 0}}]),i}(x.EventEmitter),N={x:0,y:0,width:0,height:0},V=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(){var e;return(0,o.Z)(this,i),(e=t.apply(this,arguments)).focusController=new D,e.originalWidth=0,e.originalHeight=0,e.width=0,e.height=0,e.localTransform=new k.y3,e.drawingMatrix=new k.y3,e.hitAreas={},e.textureFlipY=!1,e.viewport=[0,0,0,0],e.destroyed=!1,e}return(0,u.Z)(i,[{key:"init",value:function(){this.setupLayout(),this.setupHitAreas()}},{key:"setupLayout",value:function(){var e=this,t=this.getSize();e.originalWidth=t[0],e.originalHeight=t[1];var i=Object.assign({width:2,height:2},this.getLayout());this.localTransform.scale(i.width/2,i.height/2),e.width=this.originalWidth*this.localTransform.a,e.height=this.originalHeight*this.localTransform.d;var r=void 0!==i.x&&i.x-i.width/2||void 0!==i.centerX&&i.centerX||void 0!==i.left&&i.left-i.width/2||void 0!==i.right&&i.right+i.width/2||0,n=void 0!==i.y&&i.y-i.height/2||void 0!==i.centerY&&i.centerY||void 0!==i.top&&i.top-i.height/2||void 0!==i.bottom&&i.bottom+i.height/2||0;this.localTransform.translate(this.width*r,-this.height*n)}},{key:"setupHitAreas",value:function(){var e,t=this.getHitAreaDefs().filter((function(e){return e.index>=0})),i=(0,p.Z)(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;this.hitAreas[r.name]=r}}catch(n){i.e(n)}finally{i.f()}}},{key:"hitTest",value:function(e,t){var i=this;return Object.keys(this.hitAreas).filter((function(r){return i.isHit(r,e,t)}))}},{key:"isHit",value:function(e,t,i){if(!this.hitAreas[e])return!1;var r=this.hitAreas[e].index,n=this.getDrawableBounds(r,N);return n.x<=t&&t<=n.x+n.width&&n.y<=i&&i<=n.y+n.height}},{key:"getDrawableBounds",value:function(e,t){for(var i=this.getDrawableVertices(e),r=i[0],n=i[0],a=i[1],s=i[1],o=0;o<i.length;o+=2){var u=i[o],l=i[o+1];r=Math.min(u,r),n=Math.max(u,n),a=Math.min(l,a),s=Math.max(l,s)}return null!=t||(t={}),t.x=r,t.y=a,t.width=n-r,t.height=s-a,t}},{key:"updateTransform",value:function(e){this.drawingMatrix.copyFrom(e).append(this.localTransform)}},{key:"update",value:function(e,t){this.focusController.update(e)}},{key:"destroy",value:function(){this.destroyed=!0,this.emit("destroy"),this.motionManager.destroy(),this.motionManager=void 0}}]),i}(x.EventEmitter),j=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r,n){var a,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return(0,o.Z)(this,i),(a=t.call(this,e)).url=r,a.status=n,a.aborted=s,a}return(0,u.Z)(i)}((0,m.Z)(Error)),G=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"createXHR",value:function(t,i,r,n,a){var s=new XMLHttpRequest;if(e.allXhrSet.add(s),t){var o=e.xhrMap.get(t);o?o.add(s):(o=new Set([s]),e.xhrMap.set(t,o)),t.listeners("destroy").includes(e.cancelXHRs)||t.once("destroy",e.cancelXHRs)}return s.open("GET",i),s.responseType=r,s.onload=function(){200!==s.status&&0!==s.status||!s.response?s.onerror():n(s.response)},s.onerror=function(){w("XHRLoader","Failed to load resource as ".concat(s.responseType," (Status ").concat(s.status,"): ").concat(i)),a(new j("Network error.",i,s.status))},s.onabort=function(){return a(new j("Aborted.",i,s.status,!0))},s.onloadend=function(){var i;e.allXhrSet.delete(s),t&&(null==(i=e.xhrMap.get(t))||i.delete(s))},s}},{key:"cancelXHRs",value:function(){var t;null==(t=e.xhrMap.get(this))||t.forEach((function(t){t.abort(),e.allXhrSet.delete(t)})),e.xhrMap.delete(this)}},{key:"release",value:function(){e.allXhrSet.forEach((function(e){return e.abort()})),e.allXhrSet.clear(),e.xhrMap=new WeakMap}}]),e}(),z=G;function X(e,t){var i=-1;return function r(n,a){if(a)return Promise.reject(a);if(n<=i)return Promise.reject(new Error("next() called multiple times"));i=n;var s=e[n];if(!s)return Promise.resolve();try{return Promise.resolve(s(t,r.bind(null,n+1)))}catch(o){return Promise.reject(o)}}(0)}z.xhrMap=new WeakMap,z.allXhrSet=new Set,z.loader=function(e,t){return new Promise((function(t,i){G.createXHR(e.target,e.settings?e.settings.resolveURL(e.url):e.url,e.type,(function(i){e.result=i,t()}),i).send()}))};var W=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"load",value:function(e){return X(this.middlewares,e).then((function(){return e.result}))}}]),e}();function Y(e){var t={resourceOptions:{crossorigin:(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).crossOrigin}};if(M.xE.fromURL)return M.xE.fromURL(e,t).catch((function(e){if(e instanceof Error)throw e;var t=new Error("Texture loading error");throw t.event=e,t}));t.resourceOptions.autoLoad=!1;var i=M.xE.from(e,t);if(i.baseTexture.valid)return Promise.resolve(i);var r=i.baseTexture.resource;return null!=r._live2d_load||(r._live2d_load=new Promise((function(e,t){var n=function e(i){r.source.removeEventListener("error",e);var n=new Error("Texture loading error");n.event=i,t(n)};r.source.addEventListener("error",n),r.load().then((function(){return e(i)})).catch(n)}))),r._live2d_load}W.middlewares=[z.loader];var H="Live2DFactory",q=function(e,t){return S(void 0,null,(0,l.Z)().mark((function i(){var r;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if("string"!==typeof e.source){i.next=7;break}return i.next=3,W.load({url:e.source,type:"json",target:e.live2dModel});case 3:(r=i.sent).url=e.source,e.source=r,e.live2dModel.emit("settingsJSONLoaded",r);case 7:return i.abrupt("return",t());case 8:case"end":return i.stop()}}),i)})))},J=function(e,t){return S(void 0,null,(0,l.Z)().mark((function i(){var r,n;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!(e.source instanceof A)){i.next=5;break}return e.settings=e.source,i.abrupt("return",t());case 5:if("object"!==typeof e.source){i.next=12;break}if(!(r=ie.findRuntime(e.source))){i.next=12;break}return n=r.createModelSettings(e.source),e.settings=n,e.live2dModel.emit("settingsLoaded",n),i.abrupt("return",t());case 12:throw new TypeError("Unknown settings format.");case 13:case"end":return i.stop()}}),i)})))},Q=function(e,t){if(e.settings){var i=ie.findRuntime(e.settings);if(i)return i.ready().then(t)}return t()},K=function(e,t){return S(void 0,null,(0,l.Z)().mark((function i(){var r,n,a,s;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,t();case 2:if(!(r=e.internalModel)){i.next=13;break}if(n=e.settings,!(a=ie.findRuntime(n))){i.next=13;break}if(s=[],n.pose&&s.push(W.load({settings:n,url:n.pose,type:"json",target:r}).then((function(t){r.pose=a.createPose(r.coreModel,t),e.live2dModel.emit("poseLoaded",r.pose)})).catch((function(t){e.live2dModel.emit("poseLoadError",t),w(H,"Failed to load pose.",t)}))),n.physics&&s.push(W.load({settings:n,url:n.physics,type:"json",target:r}).then((function(t){r.physics=a.createPhysics(r.coreModel,t),e.live2dModel.emit("physicsLoaded",r.physics)})).catch((function(t){e.live2dModel.emit("physicsLoadError",t),w(H,"Failed to load physics.",t)}))),!s.length){i.next=13;break}return i.next=13,Promise.all(s);case 13:case"end":return i.stop()}}),i)})))},$=function(e,t){return S(void 0,null,(0,l.Z)().mark((function i(){var r,n;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!e.settings){i.next=17;break}return r=e.live2dModel,n=e.settings.textures.map((function(t){return Y(e.settings.resolveURL(t),{crossOrigin:e.options.crossOrigin})})),i.next=5,t();case 5:if(!e.internalModel){i.next=10;break}r.internalModel=e.internalModel,r.emit("modelLoaded",e.internalModel),i.next=11;break;case 10:throw new TypeError("Missing internal model.");case 11:return i.next=13,Promise.all(n);case 13:r.textures=i.sent,r.emit("textureLoaded",r.textures),i.next=18;break;case 17:throw new TypeError("Missing settings.");case 18:case"end":return i.stop()}}),i)})))},ee=function(e,t){return S(void 0,null,(0,l.Z)().mark((function i(){var r,n,a,s;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!((r=e.settings)instanceof A)){i.next=13;break}if(n=ie.findRuntime(r)){i.next=5;break}throw new TypeError("Unknown model settings.");case 5:return i.next=7,W.load({settings:r,url:r.moc,type:"arraybuffer",target:e.live2dModel});case 7:if(a=i.sent,n.isValidMoc(a)){i.next=10;break}throw new Error("Invalid moc data");case 10:return s=n.createCoreModel(a),e.internalModel=n.createInternalModel(s,r,e.options),i.abrupt("return",t());case 13:throw new TypeError("Missing settings.");case 14:case"end":return i.stop()}}),i)})))},te=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"registerRuntime",value:function(t){e.runtimes.push(t),e.runtimes.sort((function(e,t){return t.version-e.version}))}},{key:"findRuntime",value:function(t){var i,r=(0,p.Z)(e.runtimes);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.test(t))return n}}catch(a){r.e(a)}finally{r.f()}}},{key:"setupLive2DModel",value:function(t,i,r){return S(this,null,(0,l.Z)().mark((function n(){var a,s,o;return(0,l.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=new Promise((function(e){return t.once("textureLoaded",e)})),s=new Promise((function(e){return t.once("modelLoaded",e)})),o=Promise.all([a,s]).then((function(){return t.emit("ready")})),n.next=5,X(e.live2DModelMiddlewares,{live2dModel:t,source:i,options:r||{}});case 5:return n.next=7,o;case 7:t.emit("load");case 8:case"end":return n.stop()}}),n)})))}},{key:"loadMotion",value:function(t,i,r){var n,a=function(e){return t.emit("motionLoadError",i,r,e)};try{var s=null==(n=t.definitions[i])?void 0:n[r];if(!s)return Promise.resolve(void 0);t.listeners("destroy").includes(e.releaseTasks)||t.once("destroy",e.releaseTasks);var o=e.motionTasksMap.get(t);o||(o={},e.motionTasksMap.set(t,o));var u=o[i];u||(u=[],o[i]=u);var l=t.getMotionFile(s);return null!=u[r]||(u[r]=W.load({url:l,settings:t.settings,type:t.motionDataType,target:t}).then((function(n){var a,o=null==(a=e.motionTasksMap.get(t))?void 0:a[i];o&&delete o[r];var u=t.createMotion(n,i,s);return t.emit("motionLoaded",i,r,u),u})).catch((function(e){w(t.tag,"Failed to load motion: ".concat(l,"\n"),e),a(e)}))),u[r]}catch(h){w(t.tag,'Failed to load motion at "'.concat(i,'"[').concat(r,"]\n"),h),a(h)}return Promise.resolve(void 0)}},{key:"loadExpression",value:function(t,i){var r=function(e){return t.emit("expressionLoadError",i,e)};try{var n=t.definitions[i];if(!n)return Promise.resolve(void 0);t.listeners("destroy").includes(e.releaseTasks)||t.once("destroy",e.releaseTasks);var a=e.expressionTasksMap.get(t);a||(a=[],e.expressionTasksMap.set(t,a));var s=t.getExpressionFile(n);return null!=a[i]||(a[i]=W.load({url:s,settings:t.settings,type:"json",target:t}).then((function(r){var a=e.expressionTasksMap.get(t);a&&delete a[i];var s=t.createExpression(r,n);return t.emit("expressionLoaded",i,s),s})).catch((function(e){w(t.tag,"Failed to load expression: ".concat(s,"\n"),e),r(e)}))),a[i]}catch(o){w(t.tag,"Failed to load expression at [".concat(i,"]\n"),o),r(o)}return Promise.resolve(void 0)}},{key:"releaseTasks",value:function(){this instanceof U?e.motionTasksMap.delete(this):e.expressionTasksMap.delete(this)}}]),e}(),ie=te;ie.runtimes=[],ie.urlToJSON=q,ie.jsonToSettings=J,ie.waitUntilReady=Q,ie.setupOptionals=K,ie.setupEssentials=$,ie.createInternalModel=ee,ie.live2DModelMiddlewares=[q,J,Q,K,$,ee],ie.motionTasksMap=new WeakMap,ie.expressionTasksMap=new WeakMap,U.prototype._loadMotion=function(e,t){return ie.loadMotion(this,e,t)},F.prototype._loadExpression=function(e){return ie.loadExpression(this,e)};var re=function(){function e(){(0,o.Z)(this,e),this._autoInteract=!1}return(0,u.Z)(e,[{key:"autoInteract",get:function(){return this._autoInteract},set:function(e){e!==this._autoInteract&&(e?this.on("pointertap",ne,this):this.off("pointertap",ne,this),this._autoInteract=e)}},{key:"registerInteraction",value:function(e){e!==this.interactionManager&&(this.unregisterInteraction(),this._autoInteract&&e&&(this.interactionManager=e,e.on("pointermove",ae,this)))}},{key:"unregisterInteraction",value:function(){var e;this.interactionManager&&(null==(e=this.interactionManager)||e.off("pointermove",ae,this),this.interactionManager=void 0)}}]),e}();function ne(e){this.tap(e.data.global.x,e.data.global.y)}function ae(e){this.focus(e.data.global.x,e.data.global.y)}var se,oe=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(){return(0,o.Z)(this,i),t.apply(this,arguments)}return(0,u.Z)(i)}(k.wx),ue=new k.E9,le=new k.y3,he=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,o.Z)(this,i),(r=t.call(this)).tag="Live2DModel(uninitialized)",r.textures=[],r.transform=new oe,r.anchor=new k.AB(r.onAnchorChange,(0,d.Z)(r),0,0),r.glContextID=-1,r.elapsedTime=performance.now(),r.deltaTime=0,r._autoUpdate=!1,r.once("modelLoaded",(function(){return r.init(e)})),r}return(0,u.Z)(i,[{key:"autoUpdate",get:function(){return this._autoUpdate},set:function(e){var t;se||(se=null==(t=window.PIXI)?void 0:t.Ticker),e?this._destroyed||(se?(se.shared.add(this.onTickerUpdate,this),this._autoUpdate=!0):w(this.tag,"No Ticker registered, please call Live2DModel.registerTicker(Ticker).")):(null==se||se.shared.remove(this.onTickerUpdate,this),this._autoUpdate=!1)}},{key:"init",value:function(e){this.tag="Live2DModel(".concat(this.internalModel.settings.name,")");var t=Object.assign({autoUpdate:!0,autoInteract:!0},e);t.autoInteract&&(this.interactive=!0),this.autoInteract=t.autoInteract,this.autoUpdate=t.autoUpdate}},{key:"onAnchorChange",value:function(){this.pivot.set(this.anchor.x*this.internalModel.width,this.anchor.y*this.internalModel.height)}},{key:"motion",value:function(e,t,i){return void 0===t?this.internalModel.motionManager.startRandomMotion(e,i):this.internalModel.motionManager.startMotion(e,t,i)}},{key:"expression",value:function(e){return this.internalModel.motionManager.expressionManager?void 0===e?this.internalModel.motionManager.expressionManager.setRandomExpression():this.internalModel.motionManager.expressionManager.setExpression(e):Promise.resolve(!1)}},{key:"focus",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];ue.x=e,ue.y=t,this.toModelPosition(ue,ue,!0);var r=ue.x/this.internalModel.originalWidth*2-1,n=ue.y/this.internalModel.originalHeight*2-1,a=Math.atan2(n,r);this.internalModel.focusController.focus(Math.cos(a),-Math.sin(a),i)}},{key:"tap",value:function(e,t){var i=this.hitTest(e,t);i.length&&(C(this.tag,"Hit",i),this.emit("hit",i))}},{key:"hitTest",value:function(e,t){return ue.x=e,ue.y=t,this.toModelPosition(ue,ue),this.internalModel.hitTest(ue.x,ue.y)}},{key:"toModelPosition",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.clone();return(arguments.length>2?arguments[2]:void 0)||(this._recursivePostUpdateTransform(),this.parent?this.displayObjectUpdateTransform():(this.parent=this._tempDisplayObjectParent,this.displayObjectUpdateTransform(),this.parent=null)),this.transform.worldTransform.applyInverse(e,t),this.internalModel.localTransform.applyInverse(t,t),t}},{key:"containsPoint",value:function(e){return this.getBounds(!0).contains(e.x,e.y)}},{key:"_calculateBounds",value:function(){this._bounds.addFrame(this.transform,0,0,this.internalModel.width,this.internalModel.height)}},{key:"onTickerUpdate",value:function(){this.update(se.shared.deltaMS)}},{key:"update",value:function(e){this.deltaTime+=e,this.elapsedTime+=e}},{key:"_render",value:function(e){this.registerInteraction(e.plugins.interaction),e.batch.reset(),e.geometry.reset(),e.shader.reset(),e.state.reset();var t=!1;this.glContextID!==e.CONTEXT_UID&&(this.glContextID=e.CONTEXT_UID,this.internalModel.updateWebGLContext(e.gl,this.glContextID),t=!0);for(var i=0;i<this.textures.length;i++){var r=this.textures[i];r.valid&&(!t&&r.baseTexture._glTextures[this.glContextID]||(e.gl.pixelStorei(WebGLRenderingContext.UNPACK_FLIP_Y_WEBGL,this.internalModel.textureFlipY),e.texture.bind(r.baseTexture,0)),this.internalModel.bindTexture(i,r.baseTexture._glTextures[this.glContextID].texture),r.baseTexture.touched=e.textureGC.count)}var n=e.framebuffer.viewport;this.internalModel.viewport=[n.x,n.y,n.width,n.height],this.deltaTime&&(this.internalModel.update(this.deltaTime,this.elapsedTime),this.deltaTime=0);var a=le.copyFrom(e.globalUniforms.uniforms.projectionMatrix).append(this.worldTransform);this.internalModel.updateTransform(a),this.internalModel.draw(e.gl),e.state.reset(),e.texture.reset()}},{key:"destroy",value:function(e){this.emit("destroy"),this.autoUpdate=!1,this.unregisterInteraction(),(null==e?void 0:e.texture)&&this.textures.forEach((function(t){return t.destroy(e.baseTexture)})),this.internalModel.destroy(),(0,f.Z)((0,g.Z)(i.prototype),"destroy",this).call(this,e)}}],[{key:"from",value:function(e,t){var i=new this(t);return ie.setupLive2DModel(i,e,t).then((function(){return i}))}},{key:"fromSync",value:function(e,t){var i=new this(t);return ie.setupLive2DModel(i,e,t).then(null==t?void 0:t.onLoad).catch(null==t?void 0:t.onError),i}},{key:"registerTicker",value:function(e){se=e}}]),i}(b.W2);E(he,[re]);var ce=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"resolveURL",value:function(t,i){var r,n=null==(r=e.filesMap[t])?void 0:r[i];if(void 0===n)throw new Error("Cannot find this file from uploaded files: "+i);return n}},{key:"upload",value:function(t,i){return S(this,null,(0,l.Z)().mark((function r(){var n,a,s,o;return(0,l.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:n={},a=(0,p.Z)(i.getDefinedFiles()),r.prev=2,o=(0,l.Z)().mark((function e(){var r,a,o;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=s.value,a=decodeURI(x.url.resolve(i.url,r)),(o=t.find((function(e){return e.webkitRelativePath===a})))&&(n[r]=URL.createObjectURL(o));case 4:case"end":return e.stop()}}),e)})),a.s();case 5:if((s=a.n()).done){r.next=9;break}return r.delegateYield(o(),"t0",7);case 7:r.next=5;break;case 9:r.next=14;break;case 11:r.prev=11,r.t1=r.catch(2),a.e(r.t1);case 14:return r.prev=14,a.f(),r.finish(14);case 17:e.filesMap[i._objectURL]=n;case 18:case"end":return r.stop()}}),r,null,[[2,11,14,17]])})))}},{key:"createSettings",value:function(t){return S(this,null,(0,l.Z)().mark((function i(){var r,n,a,s,o;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(r=t.find((function(e){return e.name.endsWith("model.json")||e.name.endsWith("model3.json")}))){i.next=3;break}throw new TypeError("Settings file not found");case 3:return i.next=5,e.readText(r);case 5:if(n=i.sent,(a=JSON.parse(n)).url=r.webkitRelativePath,s=ie.findRuntime(a)){i.next=11;break}throw new Error("Unknown settings JSON");case 11:return(o=s.createModelSettings(a))._objectURL=URL.createObjectURL(r),i.abrupt("return",o);case 14:case"end":return i.stop()}}),i)})))}},{key:"readText",value:function(e){return S(this,null,(0,l.Z)().mark((function t(){return(0,l.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,i){var r=new FileReader;r.onload=function(){return t(r.result)},r.onerror=i,r.readAsText(e,"utf8")})));case 1:case"end":return t.stop()}}),t)})))}}]),e}(),de=ce;de.filesMap={},de.factory=function(e,t){return S(void 0,null,(0,l.Z)().mark((function i(){var r,n;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!(Array.isArray(e.source)&&e.source[0]instanceof File)){i.next=17;break}if(r=e.source,n=r.settings){i.next=9;break}return i.next=6,ce.createSettings(r);case 6:n=i.sent,i.next=11;break;case 9:if(n._objectURL){i.next=11;break}throw new Error('"_objectURL" must be specified in ModelSettings');case 11:return n.validateFiles(r.map((function(e){return encodeURI(e.webkitRelativePath)}))),i.next=14,ce.upload(r,n);case 14:n.resolveURL=function(e){return ce.resolveURL(this._objectURL,e)},e.source=n,e.live2dModel.once("modelLoaded",(function(e){e.once("destroy",(function(){var e=this.settings._objectURL;if(URL.revokeObjectURL(e),ce.filesMap[e])for(var t=0,i=Object.values(ce.filesMap[e]);t<i.length;t++){var r=i[t];URL.revokeObjectURL(r)}delete ce.filesMap[e]}))}));case 17:return i.abrupt("return",t());case 18:case"end":return i.stop()}}),i)})))},ie.live2DModelMiddlewares.unshift(de.factory);var fe=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"unzip",value:function(t,i){return S(this,null,(0,l.Z)().mark((function r(){var n,a,s,o,u,h,c,d,f,g;return(0,l.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.getFilePaths(t);case 2:n=r.sent,a=[],s=(0,p.Z)(i.getDefinedFiles());try{for(s.s();!(o=s.n()).done;)u=o.value,h=decodeURI(x.url.resolve(i.url,u)),n.includes(h)&&a.push(h)}catch(l){s.e(l)}finally{s.f()}return r.next=8,e.getFiles(t,a);case 8:for(c=r.sent,d=0;d<c.length;d++)f=a[d],g=c[d],Object.defineProperty(g,"webkitRelativePath",{value:f});return r.abrupt("return",c);case 11:case"end":return r.stop()}}),r)})))}},{key:"createSettings",value:function(t){return S(this,null,(0,l.Z)().mark((function i(){var r,n,a,s,o;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,e.getFilePaths(t);case 2:if(r=i.sent,n=r.find((function(e){return e.endsWith("model.json")||e.endsWith("model3.json")}))){i.next=6;break}throw new Error("Settings file not found");case 6:return i.next=8,e.readText(t,n);case 8:if(a=i.sent){i.next=11;break}throw new Error("Empty settings file: "+n);case 11:if((s=JSON.parse(a)).url=n,o=ie.findRuntime(s)){i.next=16;break}throw new Error("Unknown settings JSON");case 16:return i.abrupt("return",o.createModelSettings(s));case 17:case"end":return i.stop()}}),i)})))}},{key:"zipReader",value:function(e,t){return S(this,null,(0,l.Z)().mark((function e(){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not implemented");case 1:case"end":return e.stop()}}),e)})))}},{key:"getFilePaths",value:function(e){return S(this,null,(0,l.Z)().mark((function e(){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not implemented");case 1:case"end":return e.stop()}}),e)})))}},{key:"getFiles",value:function(e,t){return S(this,null,(0,l.Z)().mark((function e(){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not implemented");case 1:case"end":return e.stop()}}),e)})))}},{key:"readText",value:function(e,t){return S(this,null,(0,l.Z)().mark((function e(){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not implemented");case 1:case"end":return e.stop()}}),e)})))}},{key:"releaseReader",value:function(e){}}]),e}(),ge=fe;if(ge.ZIP_PROTOCOL="zip://",ge.uid=0,ge.factory=function(e,t){return S(void 0,null,(0,l.Z)().mark((function i(){var r,n,a,s,o,u;return(0,l.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if("string"!==typeof(r=e.source)||!r.endsWith(".zip")&&!r.startsWith(fe.ZIP_PROTOCOL)){i.next=8;break}return n=r.startsWith(fe.ZIP_PROTOCOL)?r.slice(fe.ZIP_PROTOCOL.length):r,i.next=5,W.load({url:n,type:"blob",target:e.live2dModel});case 5:a=i.sent,i.next=9;break;case 8:Array.isArray(r)&&1===r.length&&r[0]instanceof File&&r[0].name.endsWith(".zip")&&(a=r[0],n=URL.createObjectURL(a),s=r.settings);case 9:if(!a){i.next=27;break}if(a.size){i.next=12;break}throw new Error("Empty zip file");case 12:return i.next=14,fe.zipReader(a,n);case 14:if(o=i.sent,s){i.next=19;break}return i.next=18,fe.createSettings(o);case 18:s=i.sent;case 19:return s._objectURL=fe.ZIP_PROTOCOL+fe.uid+"/"+s.url,i.next=22,fe.unzip(o,s);case 22:(u=i.sent).settings=s,e.source=u,n.startsWith("blob:")&&e.live2dModel.once("modelLoaded",(function(e){e.once("destroy",(function(){URL.revokeObjectURL(n)}))})),fe.releaseReader(o);case 27:return i.abrupt("return",t());case 28:case"end":return i.stop()}}),i)})))},ie.live2DModelMiddlewares.unshift(ge.factory),!window.Live2D)throw new Error("Could not find Cubism 2 runtime. This plugin requires live2d.min.js to be loaded.");var me=Live2DMotion.prototype.updateParam;Live2DMotion.prototype.updateParam=function(e,t){me.call(this,e,t),t.isFinished()&&this.onFinishHandler&&(this.onFinishHandler(this),delete this.onFinishHandler)};var pe=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;return(0,o.Z)(this,i),(r=t.call(this)).params=[],r.setFadeIn(e.fade_in>0?e.fade_in:a.expressionFadingDuration),r.setFadeOut(e.fade_out>0?e.fade_out:a.expressionFadingDuration),Array.isArray(e.params)&&e.params.forEach((function(e){var t=e.calc||"add";if("add"===t){var i=e.def||0;e.val-=i}else if("mult"===t){var n=e.def||1;e.val/=n}r.params.push({calc:t,val:e.val,id:e.id})})),r}return(0,u.Z)(i,[{key:"updateParamExe",value:function(e,t,i,r){this.params.forEach((function(t){e.setParamFloat(t.id,t.val*i)}))}}]),i}(AMotion),ve=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r){var n,a;return(0,o.Z)(this,i),(n=t.call(this,e,r)).queueManager=new MotionQueueManager,n.definitions=null!=(a=n.settings.expressions)?a:[],n.init(),n}return(0,u.Z)(i,[{key:"isFinished",value:function(){return this.queueManager.isFinished()}},{key:"getExpressionIndex",value:function(e){return this.definitions.findIndex((function(t){return t.name===e}))}},{key:"getExpressionFile",value:function(e){return e.file}},{key:"createExpression",value:function(e,t){return new pe(e)}},{key:"_setExpression",value:function(e){return this.queueManager.startMotion(e)}},{key:"stopAllExpressions",value:function(){this.queueManager.stopAllMotions()}},{key:"updateParameters",value:function(e,t){return this.queueManager.updateParam(e)}}]),i}(F),_e=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r){var n;return(0,o.Z)(this,i),(n=t.call(this,e,r)).groups={idle:"idle"},n.motionDataType="arraybuffer",n.queueManager=new MotionQueueManager,n.definitions=n.settings.motions,n.init(r),n}return(0,u.Z)(i,[{key:"init",value:function(e){(0,f.Z)((0,g.Z)(i.prototype),"init",this).call(this,e),this.settings.expressions&&(this.expressionManager=new ve(this.settings,e))}},{key:"isFinished",value:function(){return this.queueManager.isFinished()}},{key:"createMotion",value:function(e,t,i){var r=Live2DMotion.loadMotion(e),n=t===this.groups.idle?a.idleMotionFadingDuration:a.motionFadingDuration;return r.setFadeIn(i.fade_in>0?i.fade_in:n),r.setFadeOut(i.fade_out>0?i.fade_out:n),r}},{key:"getMotionFile",value:function(e){return e.file}},{key:"getMotionName",value:function(e){return e.file}},{key:"getSoundFile",value:function(e){return e.sound}},{key:"_startMotion",value:function(e,t){return e.onFinishHandler=t,this.queueManager.stopAllMotions(),this.queueManager.startMotion(e)}},{key:"_stopAllMotions",value:function(){this.queueManager.stopAllMotions()}},{key:"updateParameters",value:function(e,t){return this.queueManager.updateParam(e)}},{key:"destroy",value:function(){(0,f.Z)((0,g.Z)(i.prototype),"destroy",this).call(this),this.queueManager=void 0}}]),i}(U),ye=function(){function e(t){(0,o.Z)(this,e),this.coreModel=t,this.blinkInterval=4e3,this.closingDuration=100,this.closedDuration=50,this.openingDuration=150,this.eyeState=0,this.eyeParamValue=1,this.closedTimer=0,this.nextBlinkTimeLeft=this.blinkInterval,this.leftParam=t.getParamIndex("PARAM_EYE_L_OPEN"),this.rightParam=t.getParamIndex("PARAM_EYE_R_OPEN")}return(0,u.Z)(e,[{key:"setEyeParams",value:function(e){this.eyeParamValue=I(e,0,1),this.coreModel.setParamFloat(this.leftParam,this.eyeParamValue),this.coreModel.setParamFloat(this.rightParam,this.eyeParamValue)}},{key:"update",value:function(e){switch(this.eyeState){case 0:this.nextBlinkTimeLeft-=e,this.nextBlinkTimeLeft<0&&(this.eyeState=1,this.nextBlinkTimeLeft=this.blinkInterval+this.closingDuration+this.closedDuration+this.openingDuration+(t=0,i=2e3,Math.random()*(i-t)+t));break;case 1:this.setEyeParams(this.eyeParamValue+e/this.closingDuration),this.eyeParamValue<=0&&(this.eyeState=2,this.closedTimer=0);break;case 2:this.closedTimer+=e,this.closedTimer>=this.closedDuration&&(this.eyeState=3);break;case 3:this.setEyeParams(this.eyeParamValue+e/this.openingDuration),this.eyeParamValue>=1&&(this.eyeState=0)}var t,i}}]),e}(),xe=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),ke=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r,n){var a;return(0,o.Z)(this,i),(a=t.call(this)).textureFlipY=!0,a.drawDataCount=0,a.disableCulling=!1,a.coreModel=e,a.settings=r,a.motionManager=new _e(r,n),a.eyeBlink=new ye(e),a.eyeballXParamIndex=e.getParamIndex("PARAM_EYE_BALL_X"),a.eyeballYParamIndex=e.getParamIndex("PARAM_EYE_BALL_Y"),a.angleXParamIndex=e.getParamIndex("PARAM_ANGLE_X"),a.angleYParamIndex=e.getParamIndex("PARAM_ANGLE_Y"),a.angleZParamIndex=e.getParamIndex("PARAM_ANGLE_Z"),a.bodyAngleXParamIndex=e.getParamIndex("PARAM_BODY_ANGLE_X"),a.breathParamIndex=e.getParamIndex("PARAM_BREATH"),a.init(),a}return(0,u.Z)(i,[{key:"init",value:function(){var e=this;(0,f.Z)((0,g.Z)(i.prototype),"init",this).call(this),this.settings.initParams&&this.settings.initParams.forEach((function(t){var i=t.id,r=t.value;return e.coreModel.setParamFloat(i,r)})),this.settings.initOpacities&&this.settings.initOpacities.forEach((function(t){var i=t.id,r=t.value;return e.coreModel.setPartsOpacity(i,r)})),this.coreModel.saveParam();var t=this.coreModel.getModelContext()._$aS;(null==t?void 0:t.length)&&(this.drawDataCount=t.length);var r=this.coreModel.drawParamWebGL.culling;Object.defineProperty(this.coreModel.drawParamWebGL,"culling",{set:function(e){return r=e},get:function(){return!e.disableCulling&&r}});var n=this.coreModel.getModelContext().clipManager,a=n.setupClip;n.setupClip=function(t,i){var r;a.call(n,t,i),(r=i.gl).viewport.apply(r,(0,v.Z)(e.viewport))}}},{key:"getSize",value:function(){return[this.coreModel.getCanvasWidth(),this.coreModel.getCanvasHeight()]}},{key:"getLayout",value:function(){var e={};if(this.settings.layout)for(var t=0,i=Object.keys(this.settings.layout);t<i.length;t++){var r=i[t],n=r;"center_x"===r?n="centerX":"center_y"===r&&(n="centerY"),e[n]=this.settings.layout[r]}return e}},{key:"updateWebGLContext",value:function(e,t){var i=this.coreModel.drawParamWebGL;for(var r in i.firstDraw=!0,i.setGL(e),i.glno=t,i)i.hasOwnProperty(r)&&i[r]instanceof WebGLBuffer&&(i[r]=null);var n=this.coreModel.getModelContext().clipManager;n.curFrameNo=t;var a=e.getParameter(e.FRAMEBUFFER_BINDING);n.getMaskRenderTexture(),e.bindFramebuffer(e.FRAMEBUFFER,a)}},{key:"bindTexture",value:function(e,t){this.coreModel.setTexture(e,t)}},{key:"getHitAreaDefs",value:function(){var e,t=this;return(null==(e=this.settings.hitAreas)?void 0:e.map((function(e){return{id:e.id,name:e.name,index:t.coreModel.getDrawDataIndex(e.id)}})))||[]}},{key:"getDrawableIDs",value:function(){for(var e=this.coreModel.getModelContext(),t=[],i=0;i<this.drawDataCount;i++){var r=e.getDrawData(i);r&&t.push(r.getDrawDataID().id)}return t}},{key:"getDrawableIndex",value:function(e){return this.coreModel.getDrawDataIndex(e)}},{key:"getDrawableVertices",value:function(e){if("string"===typeof e&&-1===(e=this.coreModel.getDrawDataIndex(e)))throw new TypeError("Unable to find drawable ID: "+e);return this.coreModel.getTransformedPoints(e).slice()}},{key:"update",value:function(e,t){var r,n,a,s;(0,f.Z)((0,g.Z)(i.prototype),"update",this).call(this,e,t);var o=this.coreModel;this.emit("beforeMotionUpdate");var u=this.motionManager.update(this.coreModel,t);this.emit("afterMotionUpdate"),o.saveParam(),null==(r=this.motionManager.expressionManager)||r.update(o,t),u||null==(n=this.eyeBlink)||n.update(e),this.updateFocus(),this.updateNaturalMovements(e,t),null==(a=this.physics)||a.update(t),null==(s=this.pose)||s.update(e),this.emit("beforeModelUpdate"),o.update(),o.loadParam()}},{key:"updateFocus",value:function(){this.coreModel.addToParamFloat(this.eyeballXParamIndex,this.focusController.x),this.coreModel.addToParamFloat(this.eyeballYParamIndex,this.focusController.y),this.coreModel.addToParamFloat(this.angleXParamIndex,30*this.focusController.x),this.coreModel.addToParamFloat(this.angleYParamIndex,30*this.focusController.y),this.coreModel.addToParamFloat(this.angleZParamIndex,this.focusController.x*this.focusController.y*-30),this.coreModel.addToParamFloat(this.bodyAngleXParamIndex,10*this.focusController.x)}},{key:"updateNaturalMovements",value:function(e,t){var i=t/1e3*2*Math.PI;this.coreModel.addToParamFloat(this.angleXParamIndex,15*Math.sin(i/6.5345)*.5),this.coreModel.addToParamFloat(this.angleYParamIndex,8*Math.sin(i/3.5345)*.5),this.coreModel.addToParamFloat(this.angleZParamIndex,10*Math.sin(i/5.5345)*.5),this.coreModel.addToParamFloat(this.bodyAngleXParamIndex,4*Math.sin(i/15.5345)*.5),this.coreModel.setParamFloat(this.breathParamIndex,.5+.5*Math.sin(i/3.2345))}},{key:"draw",value:function(e){var t=this.disableCulling;e.getParameter(e.FRAMEBUFFER_BINDING)&&(this.disableCulling=!0);var i=this.drawingMatrix;xe[0]=i.a,xe[1]=i.b,xe[4]=i.c,xe[5]=i.d,xe[12]=i.tx,xe[13]=i.ty,this.coreModel.setMatrix(xe),this.coreModel.draw(),this.disableCulling=t}},{key:"destroy",value:function(){(0,f.Z)((0,g.Z)(i.prototype),"destroy",this).call(this),this.coreModel=void 0}}]),i}(V),Me=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;if((0,o.Z)(this,i),(r=t.call(this,e)).motions={},!i.isValidJSON(e))throw new TypeError("Invalid JSON.");return r.moc=e.model,T("string",e,(0,d.Z)(r),"textures","textures"),r.copy(e),r}return(0,u.Z)(i,[{key:"copy",value:function(e){L("string",e,this,"name","name"),L("string",e,this,"pose","pose"),L("string",e,this,"physics","physics"),L("object",e,this,"layout","layout"),L("object",e,this,"motions","motions"),T("object",e,this,"hit_areas","hitAreas"),T("object",e,this,"expressions","expressions"),T("object",e,this,"init_params","initParams"),T("object",e,this,"init_opacities","initOpacities")}},{key:"replaceFiles",value:function(e){(0,f.Z)((0,g.Z)(i.prototype),"replaceFiles",this).call(this,e);for(var t=0,r=Object.entries(this.motions);t<r.length;t++)for(var n=(0,c.Z)(r[t],2),a=n[0],s=n[1],o=0;o<s.length;o++)s[o].file=e(s[o].file,"motions.".concat(a,"[").concat(o,"].file")),void 0!==s[o].sound&&(s[o].sound=e(s[o].sound,"motions.".concat(a,"[").concat(o,"].sound")));if(this.expressions)for(var u=0;u<this.expressions.length;u++)this.expressions[u].file=e(this.expressions[u].file,"expressions[".concat(u,"].file"))}}],[{key:"isValidJSON",value:function(e){var t;return!!e&&"string"===typeof e.model&&(null==(t=e.textures)?void 0:t.length)>0&&e.textures.every((function(e){return"string"===typeof e}))}}]),i}(A),be={x:PhysicsHair.Src.SRC_TO_X,y:PhysicsHair.Src.SRC_TO_Y,angle:PhysicsHair.Src.SRC_TO_G_ANGLE},Pe={x:PhysicsHair.Src.SRC_TO_X,y:PhysicsHair.Src.SRC_TO_Y,angle:PhysicsHair.Src.SRC_TO_G_ANGLE},Se=function(){function e(t,i){(0,o.Z)(this,e),this.coreModel=t,this.physicsHairs=[],i.physics_hair&&(this.physicsHairs=i.physics_hair.map((function(e){var t=new PhysicsHair;return t.setup(e.setup.length,e.setup.regist,e.setup.mass),e.src.forEach((function(e){var i=e.id,r=e.ptype,n=e.scale,a=e.weight,s=be[r];s&&t.addSrcParam(s,i,n,a)})),e.targets.forEach((function(e){var i=e.id,r=e.ptype,n=e.scale,a=e.weight,s=Pe[r];s&&t.addTargetParam(s,i,n,a)})),t})))}return(0,u.Z)(e,[{key:"update",value:function(e){var t=this;this.physicsHairs.forEach((function(i){return i.update(t.coreModel,e)}))}}]),e}(),Ce=function(){function e(t){(0,o.Z)(this,e),this.id=t,this.paramIndex=-1,this.partsIndex=-1,this.link=[]}return(0,u.Z)(e,[{key:"initIndex",value:function(e){this.paramIndex=e.getParamIndex("VISIBLE:"+this.id),this.partsIndex=e.getPartsDataIndex(PartsDataID.getID(this.id)),e.setParamFloat(this.paramIndex,1)}}]),e}(),we=function(){function e(t,i){(0,o.Z)(this,e),this.coreModel=t,this.opacityAnimDuration=500,this.partsGroups=[],i.parts_visible&&(this.partsGroups=i.parts_visible.map((function(e){return e.group.map((function(e){var t=e.id,i=e.link,r=new Ce(t);return i&&(r.link=i.map((function(e){return new Ce(e)}))),r}))})),this.init())}return(0,u.Z)(e,[{key:"init",value:function(){var e=this;this.partsGroups.forEach((function(t){t.forEach((function(t){if(t.initIndex(e.coreModel),t.paramIndex>=0){var i=0!==e.coreModel.getParamFloat(t.paramIndex);e.coreModel.setPartsOpacity(t.partsIndex,i?1:0),e.coreModel.setParamFloat(t.paramIndex,i?1:0),t.link.length>0&&t.link.forEach((function(t){return t.initIndex(e.coreModel)}))}}))}))}},{key:"normalizePartsOpacityGroup",value:function(e,t){var i=this.coreModel,r=.5,n=1,a=e.findIndex((function(e){var t=e.paramIndex;return e.partsIndex>=0&&0!==i.getParamFloat(t)}));if(a>=0){var s=i.getPartsOpacity(e[a].partsIndex);n=I(s+t/this.opacityAnimDuration,0,1)}else a=0,n=1;e.forEach((function(e,t){var s=e.partsIndex;if(s>=0)if(a==t)i.setPartsOpacity(s,n);else{var o,u=i.getPartsOpacity(s);(1-(o=n<r?-.5*n/r+1:(1-n)*r/.5))*(1-n)>.15&&(o=1-.15/(1-n)),u>o&&(u=o),i.setPartsOpacity(s,u)}}))}},{key:"copyOpacity",value:function(e){var t=this.coreModel;e.forEach((function(e){var i=e.partsIndex,r=e.link;if(i>=0&&r){var n=t.getPartsOpacity(i);r.forEach((function(e){var i=e.partsIndex;i>=0&&t.setPartsOpacity(i,n)}))}}))}},{key:"update",value:function(e){var t=this;this.partsGroups.forEach((function(i){t.normalizePartsOpacityGroup(i,e),t.copyOpacity(i)}))}}]),e}();if(ie.registerRuntime({version:2,test:function(e){return e instanceof Me||Me.isValidJSON(e)},ready:function(){return Promise.resolve()},isValidMoc:function(e){if(e.byteLength<3)return!1;var t=new Int8Array(e,0,3);return"moc"===String.fromCharCode.apply(String,(0,v.Z)(t))},createModelSettings:function(e){return new Me(e)},createCoreModel:function(e){var t=Live2DModelWebGL.loadModel(e),i=Live2D.getError();if(i)throw i;return t},createInternalModel:function(e,t,i){return new ke(e,t,i)},createPose:function(e,t){return new we(e,t)},createPhysics:function(e,t){return new Se(e,t)}}),!window.Live2DCubismCore)throw new Error("Could not find Cubism 4 runtime. This plugin requires live2dcubismcore.js to be loaded.");var Ie=function(){function e(t,i){(0,o.Z)(this,e),this.x=t||0,this.y=i||0}return(0,u.Z)(e,[{key:"add",value:function(t){var i=new e(0,0);return i.x=this.x+t.x,i.y=this.y+t.y,i}},{key:"substract",value:function(t){var i=new e(0,0);return i.x=this.x-t.x,i.y=this.y-t.y,i}},{key:"multiply",value:function(t){var i=new e(0,0);return i.x=this.x*t.x,i.y=this.y*t.y,i}},{key:"multiplyByScaler",value:function(t){return this.multiply(new e(t,t))}},{key:"division",value:function(t){var i=new e(0,0);return i.x=this.x/t.x,i.y=this.y/t.y,i}},{key:"divisionByScalar",value:function(t){return this.division(new e(t,t))}},{key:"getLength",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"getDistanceWith",value:function(e){return Math.sqrt((this.x-e.x)*(this.x-e.x)+(this.y-e.y)*(this.y-e.y))}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"normalize",value:function(){var e=Math.pow(this.x*this.x+this.y*this.y,.5);this.x=this.x/e,this.y=this.y/e}},{key:"isEqual",value:function(e){return this.x==e.x&&this.y==e.y}},{key:"isNotEqual",value:function(e){return!this.isEqual(e)}}]),e}(),Le=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"range",value:function(e,t,i){return e<t?e=t:e>i&&(e=i),e}},{key:"sin",value:function(e){return Math.sin(e)}},{key:"cos",value:function(e){return Math.cos(e)}},{key:"abs",value:function(e){return Math.abs(e)}},{key:"sqrt",value:function(e){return Math.sqrt(e)}},{key:"cbrt",value:function(e){if(0===e)return e;var t,i=e,r=i<0;return r&&(i=-i),t=i===1/0?1/0:(i/((t=Math.exp(Math.log(i)/3))*t)+2*t)/3,r?-t:t}},{key:"getEasingSine",value:function(e){return e<0?0:e>1?1:.5-.5*this.cos(e*Math.PI)}},{key:"max",value:function(e,t){return e>t?e:t}},{key:"min",value:function(e,t){return e>t?t:e}},{key:"degreesToRadian",value:function(e){return e/180*Math.PI}},{key:"radianToDegrees",value:function(e){return 180*e/Math.PI}},{key:"directionToRadian",value:function(e,t){for(var i=Math.atan2(t.y,t.x)-Math.atan2(e.y,e.x);i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;return i}},{key:"directionToDegrees",value:function(e,t){var i=this.directionToRadian(e,t),r=this.radianToDegrees(i);return t.x-e.x>0&&(r=-r),r}},{key:"radianToDirection",value:function(e){var t=new Ie;return t.x=this.sin(e),t.y=this.cos(e),t}},{key:"quadraticEquation",value:function(t,i,r){return this.abs(t)<e.Epsilon?this.abs(i)<e.Epsilon?-r:-r/i:-(i+this.sqrt(i*i-4*t*r))/(2*t)}},{key:"cardanoAlgorithmForBezier",value:function(t,i,r,n){if(this.sqrt(t)<e.Epsilon)return this.range(this.quadraticEquation(i,r,n),0,1);var a=i/t,s=r/t,o=(3*s-a*a)/3,u=o/3,l=(2*a*a*a-9*a*s+27*(n/t))/27,h=l/2,c=h*h+u*u*u,d=.5,f=.51;if(c<0){var g=-o/3,m=g*g*g,p=this.sqrt(m),v=-l/(2*p),_=this.range(v,-1,1),y=Math.acos(_),x=2*this.cbrt(p),k=x*this.cos(y/3)-a/3;if(this.abs(k-d)<f)return this.range(k,0,1);var M=x*this.cos((y+2*Math.PI)/3)-a/3;if(this.abs(M-d)<f)return this.range(M,0,1);var b=x*this.cos((y+4*Math.PI)/3)-a/3;return this.range(b,0,1)}if(0==c){var P,S=2*(P=h<0?this.cbrt(-h):-this.cbrt(h))-a/3;if(this.abs(S-d)<f)return this.range(S,0,1);var C=-P-a/3;return this.range(C,0,1)}var w=this.sqrt(c),I=this.cbrt(w-h)-this.cbrt(w+h)-a/3;return this.range(I,0,1)}}]),e}(),Te=Le;Te.Epsilon=1e-5;var Ee=function(){function e(){(0,o.Z)(this,e),this._tr=new Float32Array(16),this.loadIdentity()}return(0,u.Z)(e,[{key:"loadIdentity",value:function(){var e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setMatrix(e)}},{key:"setMatrix",value:function(e){for(var t=0;t<16;++t)this._tr[t]=e[t]}},{key:"getArray",value:function(){return this._tr}},{key:"getScaleX",value:function(){return this._tr[0]}},{key:"getScaleY",value:function(){return this._tr[5]}},{key:"getTranslateX",value:function(){return this._tr[12]}},{key:"getTranslateY",value:function(){return this._tr[13]}},{key:"transformX",value:function(e){return this._tr[0]*e+this._tr[12]}},{key:"transformY",value:function(e){return this._tr[5]*e+this._tr[13]}},{key:"invertTransformX",value:function(e){return(e-this._tr[12])/this._tr[0]}},{key:"invertTransformY",value:function(e){return(e-this._tr[13])/this._tr[5]}},{key:"translateRelative",value:function(t,i){var r=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,i,0,1]);e.multiply(r,this._tr,this._tr)}},{key:"translate",value:function(e,t){this._tr[12]=e,this._tr[13]=t}},{key:"translateX",value:function(e){this._tr[12]=e}},{key:"translateY",value:function(e){this._tr[13]=e}},{key:"scaleRelative",value:function(t,i){var r=new Float32Array([t,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1]);e.multiply(r,this._tr,this._tr)}},{key:"scale",value:function(e,t){this._tr[0]=e,this._tr[5]=t}},{key:"multiplyByMatrix",value:function(t){e.multiply(t.getArray(),this._tr,this._tr)}},{key:"clone",value:function(){for(var t=new e,i=0;i<this._tr.length;i++)t._tr[i]=this._tr[i];return t}}],[{key:"multiply",value:function(e,t,i){for(var r=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),n=0;n<4;++n)for(var a=0;a<4;++a)for(var s=0;s<4;++s)r[a+4*n]+=e[s+4*n]*t[a+4*s];for(var o=0;o<16;++o)i[o]=r[o]}}]),e}(),Fe=function(){function e(){(0,o.Z)(this,e),this._isCulling=!1,this._isPremultipliedAlpha=!1,this._anisortopy=0,this._modelColor=new Ae,this._mvpMatrix4x4=new Ee,this._mvpMatrix4x4.loadIdentity()}return(0,u.Z)(e,[{key:"initialize",value:function(e){this._model=e}},{key:"drawModel",value:function(){null!=this.getModel()&&this.doDrawModel()}},{key:"setMvpMatrix",value:function(e){this._mvpMatrix4x4.setMatrix(e.getArray())}},{key:"getMvpMatrix",value:function(){return this._mvpMatrix4x4}},{key:"setModelColor",value:function(e,t,i,r){e<0?e=0:e>1&&(e=1),t<0?t=0:t>1&&(t=1),i<0?i=0:i>1&&(i=1),r<0?r=0:r>1&&(r=1),this._modelColor.R=e,this._modelColor.G=t,this._modelColor.B=i,this._modelColor.A=r}},{key:"getModelColor",value:function(){return Object.assign({},this._modelColor)}},{key:"setIsPremultipliedAlpha",value:function(e){this._isPremultipliedAlpha=e}},{key:"isPremultipliedAlpha",value:function(){return this._isPremultipliedAlpha}},{key:"setIsCulling",value:function(e){this._isCulling=e}},{key:"isCulling",value:function(){return this._isCulling}},{key:"setAnisotropy",value:function(e){this._anisortopy=e}},{key:"getAnisotropy",value:function(){return this._anisortopy}},{key:"getModel",value:function(){return this._model}}]),e}(),De=function(e){return e[e.CubismBlendMode_Normal=0]="CubismBlendMode_Normal",e[e.CubismBlendMode_Additive=1]="CubismBlendMode_Additive",e[e.CubismBlendMode_Multiplicative=2]="CubismBlendMode_Multiplicative",e}(De||{}),Ae=(0,u.Z)((function e(){(0,o.Z)(this,e),this.R=1,this.G=1,this.B=1,this.A=1})),Re=!1,Be=!1,Oe=void 0,Ze=0,Ue=2,Ne=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"startUp",value:function(e){if(Re)return Ge("CubismFramework.startUp() is already done."),Re;if(Live2DCubismCore._isStarted)return Re=!0,!0;if(Live2DCubismCore._isStarted=!0,(Oe=e)&&Live2DCubismCore.Logging.csmSetLogFunction(Oe.logFunction),Re=!0){var t=Live2DCubismCore.Version.csmGetVersion(),i=(16711680&t)>>16,r=65535&t,n=t;Ge("Live2D Cubism Core version: {0}.{1}.{2} ({3})",("00"+((4278190080&t)>>24)).slice(-2),("00"+i).slice(-2),("0000"+r).slice(-4),n)}return Ge("CubismFramework.startUp() is complete."),Re}},{key:"cleanUp",value:function(){Re=!1,Be=!1,Oe=void 0}},{key:"initialize",value:function(){Re?Be?ze("CubismFramework.initialize() skipped, already initialized."):(Be=!0,Ge("CubismFramework.initialize() is complete.")):ze("CubismFramework is not started.")}},{key:"dispose",value:function(){Re?Be?(Fe.staticRelease(),Be=!1,Ge("CubismFramework.dispose() is complete.")):ze("CubismFramework.dispose() skipped, not initialized."):ze("CubismFramework is not started.")}},{key:"isStarted",value:function(){return Re}},{key:"isInitialized",value:function(){return Be}},{key:"coreLogFunction",value:function(e){Live2DCubismCore.Logging.csmGetLogFunction()&&Live2DCubismCore.Logging.csmGetLogFunction()(e)}},{key:"getLoggingLevel",value:function(){return null!=Oe?Oe.loggingLevel:Ve.LogLevel_Off}}]),e}(),Ve=function(e){return e[e.LogLevel_Verbose=0]="LogLevel_Verbose",e[e.LogLevel_Debug=1]="LogLevel_Debug",e[e.LogLevel_Info=2]="LogLevel_Info",e[e.LogLevel_Warning=3]="LogLevel_Warning",e[e.LogLevel_Error=4]="LogLevel_Error",e[e.LogLevel_Off=5]="LogLevel_Off",e}(Ve||{});function je(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];We.print(Ve.LogLevel_Debug,"[CSM][D]"+e+"\n",i)}function Ge(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];We.print(Ve.LogLevel_Info,"[CSM][I]"+e+"\n",i)}function ze(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];We.print(Ve.LogLevel_Warning,"[CSM][W]"+e+"\n",i)}function Xe(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];We.print(Ve.LogLevel_Error,"[CSM][E]"+e+"\n",i)}var We=function(){function e(){(0,o.Z)(this,e)}return(0,u.Z)(e,null,[{key:"print",value:function(e,t,i){if(!(e<Ne.getLoggingLevel())){var r=Ne.coreLogFunction;if(r)r(t.replace(/{(\d+)}/g,(function(e,t){return i[t]})))}}},{key:"dumpBytes",value:function(e,t,i){for(var r=0;r<i;r++)r%16==0&&r>0?this.print(e,"\n"):r%8==0&&r>0&&this.print(e,"  "),this.print(e,"{0} ",[255&t[r]]);this.print(e,"\n")}}]),e}(),Ye=function(){function e(){(0,o.Z)(this,e),this._fadeInSeconds=-1,this._fadeOutSeconds=-1,this._weight=1,this._offsetSeconds=0,this._firedEventValues=[]}return(0,u.Z)(e,[{key:"release",value:function(){this._weight=0}},{key:"updateParameters",value:function(e,t,i){if(t.isAvailable()&&!t.isFinished()){if(!t.isStarted()){t.setIsStarted(!0),t.setStartTime(i-this._offsetSeconds),t.setFadeInStartTime(i);var r=this.getDuration();t.getEndTime()<0&&t.setEndTime(r<=0?-1:t.getStartTime()+r)}var n=this._weight;n=n*(0==this._fadeInSeconds?1:Te.getEasingSine((i-t.getFadeInStartTime())/this._fadeInSeconds))*(0==this._fadeOutSeconds||t.getEndTime()<0?1:Te.getEasingSine((t.getEndTime()-i)/this._fadeOutSeconds)),t.setState(i,n),this.doUpdateParameters(e,i,n,t),t.getEndTime()>0&&t.getEndTime()<i&&t.setIsFinished(!0)}}},{key:"setFadeInTime",value:function(e){this._fadeInSeconds=e}},{key:"setFadeOutTime",value:function(e){this._fadeOutSeconds=e}},{key:"getFadeOutTime",value:function(){return this._fadeOutSeconds}},{key:"getFadeInTime",value:function(){return this._fadeInSeconds}},{key:"setWeight",value:function(e){this._weight=e}},{key:"getWeight",value:function(){return this._weight}},{key:"getDuration",value:function(){return-1}},{key:"getLoopDuration",value:function(){return-1}},{key:"setOffsetTime",value:function(e){this._offsetSeconds=e}},{key:"getFiredEvent",value:function(e,t){return this._firedEventValues}},{key:"setFinishedMotionHandler",value:function(e){this._onFinishedMotion=e}},{key:"getFinishedMotionHandler",value:function(){return this._onFinishedMotion}}]),e}(),He=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(){var e;return(0,o.Z)(this,i),(e=t.call(this))._parameters=[],e}return(0,u.Z)(i,[{key:"doUpdateParameters",value:function(e,t,i,r){for(var n=0;n<this._parameters.length;++n){var a=this._parameters[n];switch(a.blendType){case qe.ExpressionBlendType_Add:e.addParameterValueById(a.parameterId,a.value,i);break;case qe.ExpressionBlendType_Multiply:e.multiplyParameterValueById(a.parameterId,a.value,i);break;case qe.ExpressionBlendType_Overwrite:e.setParameterValueById(a.parameterId,a.value,i)}}}}],[{key:"create",value:function(e){var t=new i,r=e.FadeInTime,n=e.FadeOutTime;t.setFadeInTime(void 0!==r?r:1),t.setFadeOutTime(void 0!==n?n:1);for(var a=e.Parameters||[],s=0;s<a.length;++s){var o=a[s],u=o.Id,l=o.Value,h=void 0;switch(o.Blend){case"Multiply":h=qe.ExpressionBlendType_Multiply;break;case"Overwrite":h=qe.ExpressionBlendType_Overwrite;break;default:h=qe.ExpressionBlendType_Add}var c={parameterId:u,blendType:h,value:l};t._parameters.push(c)}return t}}]),i}(Ye),qe=function(e){return e[e.ExpressionBlendType_Add=0]="ExpressionBlendType_Add",e[e.ExpressionBlendType_Multiply=1]="ExpressionBlendType_Multiply",e[e.ExpressionBlendType_Overwrite=2]="ExpressionBlendType_Overwrite",e}(qe||{}),Je=function(){function e(){(0,o.Z)(this,e),this._autoDelete=!1,this._available=!0,this._finished=!1,this._started=!1,this._startTimeSeconds=-1,this._fadeInStartTimeSeconds=0,this._endTimeSeconds=-1,this._stateTimeSeconds=0,this._stateWeight=0,this._lastEventCheckSeconds=0,this._motionQueueEntryHandle=this,this._fadeOutSeconds=0,this._isTriggeredFadeOut=!1}return(0,u.Z)(e,[{key:"release",value:function(){this._autoDelete&&this._motion&&this._motion.release()}},{key:"setFadeOut",value:function(e){this._fadeOutSeconds=e,this._isTriggeredFadeOut=!0}},{key:"startFadeOut",value:function(e,t){var i=t+e;this._isTriggeredFadeOut=!0,(this._endTimeSeconds<0||i<this._endTimeSeconds)&&(this._endTimeSeconds=i)}},{key:"isFinished",value:function(){return this._finished}},{key:"isStarted",value:function(){return this._started}},{key:"getStartTime",value:function(){return this._startTimeSeconds}},{key:"getFadeInStartTime",value:function(){return this._fadeInStartTimeSeconds}},{key:"getEndTime",value:function(){return this._endTimeSeconds}},{key:"setStartTime",value:function(e){this._startTimeSeconds=e}},{key:"setFadeInStartTime",value:function(e){this._fadeInStartTimeSeconds=e}},{key:"setEndTime",value:function(e){this._endTimeSeconds=e}},{key:"setIsFinished",value:function(e){this._finished=e}},{key:"setIsStarted",value:function(e){this._started=e}},{key:"isAvailable",value:function(){return this._available}},{key:"setIsAvailable",value:function(e){this._available=e}},{key:"setState",value:function(e,t){this._stateTimeSeconds=e,this._stateWeight=t}},{key:"getStateTime",value:function(){return this._stateTimeSeconds}},{key:"getStateWeight",value:function(){return this._stateWeight}},{key:"getLastCheckEventSeconds",value:function(){return this._lastEventCheckSeconds}},{key:"setLastCheckEventSeconds",value:function(e){this._lastEventCheckSeconds=e}},{key:"isTriggeredFadeOut",value:function(){return this._isTriggeredFadeOut}},{key:"getFadeOutSeconds",value:function(){return this._fadeOutSeconds}}]),e}(),Qe=function(){function e(){(0,o.Z)(this,e),this._userTimeSeconds=0,this._eventCustomData=null,this._motions=[]}return(0,u.Z)(e,[{key:"release",value:function(){for(var e=0;e<this._motions.length;++e)this._motions[e]&&this._motions[e].release();this._motions=void 0}},{key:"startMotion",value:function(e,t,i){if(null==e)return Ke;for(var r,n=0;n<this._motions.length;++n)null!=(r=this._motions[n])&&r.setFadeOut(r._motion.getFadeOutTime());return(r=new Je)._autoDelete=t,r._motion=e,this._motions.push(r),r._motionQueueEntryHandle}},{key:"isFinished",value:function(){for(var e=0;e<this._motions.length;){var t=this._motions[e];if(null!=t)if(null!=t._motion){if(!t.isFinished())return!1;e++}else t.release(),this._motions.splice(e,1);else this._motions.splice(e,1)}return!0}},{key:"isFinishedByHandle",value:function(e){for(var t=0;t<this._motions.length;t++){var i=this._motions[t];if(null!=i&&(i._motionQueueEntryHandle==e&&!i.isFinished()))return!1}return!0}},{key:"stopAllMotions",value:function(){for(var e=0;e<this._motions.length;e++){var t=this._motions[e];null!=t&&t.release()}this._motions=[]}},{key:"getCubismMotionQueueEntry",value:function(e){return this._motions.find((function(t){return null!=t&&t._motionQueueEntryHandle==e}))}},{key:"setEventCallback",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._eventCallBack=e,this._eventCustomData=t}},{key:"doUpdateMotion",value:function(e,t){for(var i=!1,r=0;r<this._motions.length;){var n=this._motions[r];if(null!=n){var a=n._motion;if(null!=a){a.updateParameters(e,n,t),i=!0;for(var s=a.getFiredEvent(n.getLastCheckEventSeconds()-n.getStartTime(),t-n.getStartTime()),o=0;o<s.length;++o)this._eventCallBack(this,s[o],this._eventCustomData);n.setLastCheckEventSeconds(t),n.isFinished()?(n.release(),this._motions.splice(r,1)):(n.isTriggeredFadeOut()&&n.startFadeOut(n.getFadeOutSeconds(),t),r++)}else n.release(),this._motions.splice(r,1)}else this._motions.splice(r,1)}return i}}]),e}(),Ke=-1,$e=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r){var n,a;return(0,o.Z)(this,i),(n=t.call(this,e,r)).queueManager=new Qe,n.definitions=null!=(a=e.expressions)?a:[],n.init(),n}return(0,u.Z)(i,[{key:"isFinished",value:function(){return this.queueManager.isFinished()}},{key:"getExpressionIndex",value:function(e){return this.definitions.findIndex((function(t){return t.Name===e}))}},{key:"getExpressionFile",value:function(e){return e.File}},{key:"createExpression",value:function(e,t){return He.create(e)}},{key:"_setExpression",value:function(e){return this.queueManager.startMotion(e,!1,performance.now())}},{key:"stopAllExpressions",value:function(){this.queueManager.stopAllMotions()}},{key:"updateParameters",value:function(e,t){return this.queueManager.doUpdateMotion(e,t)}}]),i}(F),et=function(){function e(t){(0,o.Z)(this,e),this.groups=t.Groups,this.hitAreas=t.HitAreas,this.layout=t.Layout,this.moc=t.FileReferences.Moc,this.expressions=t.FileReferences.Expressions,this.motions=t.FileReferences.Motions,this.textures=t.FileReferences.Textures,this.physics=t.FileReferences.Physics,this.pose=t.FileReferences.Pose}return(0,u.Z)(e,[{key:"getEyeBlinkParameters",value:function(){var e,t;return null==(t=null==(e=this.groups)?void 0:e.find((function(e){return"EyeBlink"===e.Name})))?void 0:t.Ids}},{key:"getLipSyncParameters",value:function(){var e,t;return null==(t=null==(e=this.groups)?void 0:e.find((function(e){return"LipSync"===e.Name})))?void 0:t.Ids}}]),e}(),tt=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e){var r;if((0,o.Z)(this,i),r=t.call(this,e),!i.isValidJSON(e))throw new TypeError("Invalid JSON.");return Object.assign((0,d.Z)(r),new et(e)),r}return(0,u.Z)(i,[{key:"replaceFiles",value:function(e){if((0,f.Z)((0,g.Z)(i.prototype),"replaceFiles",this).call(this,e),this.motions)for(var t=0,r=Object.entries(this.motions);t<r.length;t++)for(var n=(0,c.Z)(r[t],2),a=n[0],s=n[1],o=0;o<s.length;o++)s[o].File=e(s[o].File,"motions.".concat(a,"[").concat(o,"].File")),void 0!==s[o].Sound&&(s[o].Sound=e(s[o].Sound,"motions.".concat(a,"[").concat(o,"].Sound")));if(this.expressions)for(var u=0;u<this.expressions.length;u++)this.expressions[u].File=e(this.expressions[u].File,"expressions[".concat(u,"].File"))}}],[{key:"isValidJSON",value:function(e){var t;return!!(null==e?void 0:e.FileReferences)&&"string"===typeof e.FileReferences.Moc&&(null==(t=e.FileReferences.Textures)?void 0:t.length)>0&&e.FileReferences.Textures.every((function(e){return"string"===typeof e}))}}]),i}(A);E(tt,[et]);var it=function(e){return e[e.CubismMotionCurveTarget_Model=0]="CubismMotionCurveTarget_Model",e[e.CubismMotionCurveTarget_Parameter=1]="CubismMotionCurveTarget_Parameter",e[e.CubismMotionCurveTarget_PartOpacity=2]="CubismMotionCurveTarget_PartOpacity",e}(it||{}),rt=function(e){return e[e.CubismMotionSegmentType_Linear=0]="CubismMotionSegmentType_Linear",e[e.CubismMotionSegmentType_Bezier=1]="CubismMotionSegmentType_Bezier",e[e.CubismMotionSegmentType_Stepped=2]="CubismMotionSegmentType_Stepped",e[e.CubismMotionSegmentType_InverseStepped=3]="CubismMotionSegmentType_InverseStepped",e}(rt||{}),nt=(0,u.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,o.Z)(this,e),this.time=t,this.value=i})),at=(0,u.Z)((function e(){(0,o.Z)(this,e),this.basePointIndex=0,this.segmentType=0})),st=(0,u.Z)((function e(){(0,o.Z)(this,e),this.id="",this.type=0,this.segmentCount=0,this.baseSegmentIndex=0,this.fadeInTime=0,this.fadeOutTime=0})),ot=(0,u.Z)((function e(){(0,o.Z)(this,e),this.fireTime=0,this.value=""})),ut=(0,u.Z)((function e(){(0,o.Z)(this,e),this.duration=0,this.loop=!1,this.curveCount=0,this.eventCount=0,this.fps=0,this.curves=[],this.segments=[],this.points=[],this.events=[]})),lt=function(){function e(t){(0,o.Z)(this,e),this._json=t}return(0,u.Z)(e,[{key:"release",value:function(){this._json=void 0}},{key:"getMotionDuration",value:function(){return this._json.Meta.Duration}},{key:"isMotionLoop",value:function(){return this._json.Meta.Loop||!1}},{key:"getEvaluationOptionFlag",value:function(e){return ht.EvaluationOptionFlag_AreBeziersRistricted==e&&!!this._json.Meta.AreBeziersRestricted}},{key:"getMotionCurveCount",value:function(){return this._json.Meta.CurveCount}},{key:"getMotionFps",value:function(){return this._json.Meta.Fps}},{key:"getMotionTotalSegmentCount",value:function(){return this._json.Meta.TotalSegmentCount}},{key:"getMotionTotalPointCount",value:function(){return this._json.Meta.TotalPointCount}},{key:"getMotionFadeInTime",value:function(){return this._json.Meta.FadeInTime}},{key:"getMotionFadeOutTime",value:function(){return this._json.Meta.FadeOutTime}},{key:"getMotionCurveTarget",value:function(e){return this._json.Curves[e].Target}},{key:"getMotionCurveId",value:function(e){return this._json.Curves[e].Id}},{key:"getMotionCurveFadeInTime",value:function(e){return this._json.Curves[e].FadeInTime}},{key:"getMotionCurveFadeOutTime",value:function(e){return this._json.Curves[e].FadeOutTime}},{key:"getMotionCurveSegmentCount",value:function(e){return this._json.Curves[e].Segments.length}},{key:"getMotionCurveSegment",value:function(e,t){return this._json.Curves[e].Segments[t]}},{key:"getEventCount",value:function(){return this._json.Meta.UserDataCount||0}},{key:"getTotalEventValueSize",value:function(){return this._json.Meta.TotalUserDataSize}},{key:"getEventTime",value:function(e){return this._json.UserData[e].Time}},{key:"getEventValue",value:function(e){return this._json.UserData[e].Value}}]),e}(),ht=function(e){return e[e.EvaluationOptionFlag_AreBeziersRistricted=0]="EvaluationOptionFlag_AreBeziersRistricted",e}(ht||{});function ct(e,t,i){var r=new nt;return r.time=e.time+(t.time-e.time)*i,r.value=e.value+(t.value-e.value)*i,r}function dt(e,t){var i=(t-e[0].time)/(e[1].time-e[0].time);return i<0&&(i=0),e[0].value+(e[1].value-e[0].value)*i}function ft(e,t){var i=(t-e[0].time)/(e[3].time-e[0].time);i<0&&(i=0);var r=ct(e[0],e[1],i),n=ct(e[1],e[2],i),a=ct(e[2],e[3],i),s=ct(r,n,i),o=ct(n,a,i);return ct(s,o,i).value}function gt(e,t){var i=t,r=e[0].time,n=e[3].time,a=e[1].time,s=e[2].time,o=n-3*s+3*a-r,u=3*s-6*a+3*r,l=3*a-3*r,h=r-i,c=Te.cardanoAlgorithmForBezier(o,u,l,h),d=ct(e[0],e[1],c),f=ct(e[1],e[2],c),g=ct(e[2],e[3],c),m=ct(d,f,c),p=ct(f,g,c);return ct(m,p,c).value}function mt(e,t){return e[0].value}function pt(e,t){return e[1].value}function vt(e,t,i){for(var r=e.curves[t],n=-1,a=r.baseSegmentIndex+r.segmentCount,s=0,o=r.baseSegmentIndex;o<a;++o)if(s=e.segments[o].basePointIndex+(e.segments[o].segmentType==rt.CubismMotionSegmentType_Bezier?3:1),e.points[s].time>i){n=o;break}if(-1==n)return e.points[s].value;var u=e.segments[n];return u.evaluate(e.points.slice(u.basePointIndex),i)}var _t=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(){var e;return(0,o.Z)(this,i),(e=t.call(this))._eyeBlinkParameterIds=[],e._lipSyncParameterIds=[],e._sourceFrameRate=30,e._loopDurationSeconds=-1,e._isLoop=!1,e._isLoopFadeIn=!0,e._lastWeight=0,e}return(0,u.Z)(i,[{key:"doUpdateParameters",value:function(e,t,i,n){null==this._modelCurveIdEyeBlink&&(this._modelCurveIdEyeBlink="EyeBlink"),null==this._modelCurveIdLipSync&&(this._modelCurveIdLipSync="LipSync");var a=t-n.getStartTime();a<0&&(a=0);var s=Number.MAX_VALUE,o=Number.MAX_VALUE,u=64,l=0,h=0;this._eyeBlinkParameterIds.length>u&&je("too many eye blink targets : {0}",this._eyeBlinkParameterIds.length),this._lipSyncParameterIds.length>u&&je("too many lip sync targets : {0}",this._lipSyncParameterIds.length);var c,d,f,g=this._fadeInSeconds<=0?1:Te.getEasingSine((t-n.getFadeInStartTime())/this._fadeInSeconds),m=this._fadeOutSeconds<=0||n.getEndTime()<0?1:Te.getEasingSine((n.getEndTime()-t)/this._fadeOutSeconds),p=a;if(this._isLoop)for(;p>this._motionData.duration;)p-=this._motionData.duration;var v=this._motionData.curves;for(d=0;d<this._motionData.curveCount&&v[d].type==it.CubismMotionCurveTarget_Model;++d)c=vt(this._motionData,d,p),v[d].id==this._modelCurveIdEyeBlink?o=c:v[d].id==this._modelCurveIdLipSync&&(s=c);for(;d<this._motionData.curveCount&&v[d].type==it.CubismMotionCurveTarget_Parameter;++d)if(-1!=(f=e.getParameterIndex(v[d].id))){var _=e.getParameterValueByIndex(f);if(c=vt(this._motionData,d,p),o!=Number.MAX_VALUE)for(var y=0;y<this._eyeBlinkParameterIds.length&&y<u;++y)if(this._eyeBlinkParameterIds[y]==v[d].id){c*=o,h|=1<<y;break}if(s!=Number.MAX_VALUE)for(var x=0;x<this._lipSyncParameterIds.length&&x<u;++x)if(this._lipSyncParameterIds[x]==v[d].id){c+=s,l|=1<<x;break}var k=void 0;if(v[d].fadeInTime<0&&v[d].fadeOutTime<0)k=_+(c-_)*i;else{var M=void 0,b=void 0;M=v[d].fadeInTime<0?g:0==v[d].fadeInTime?1:Te.getEasingSine((t-n.getFadeInStartTime())/v[d].fadeInTime),b=v[d].fadeOutTime<0?m:0==v[d].fadeOutTime||n.getEndTime()<0?1:Te.getEasingSine((n.getEndTime()-t)/v[d].fadeOutTime),k=_+(c-_)*(this._weight*M*b)}e.setParameterValueByIndex(f,k,1)}if(o!=Number.MAX_VALUE)for(var P=0;P<this._eyeBlinkParameterIds.length&&P<u;++P){var S=e.getParameterValueById(this._eyeBlinkParameterIds[P]);if(!(h>>P&1)){var C=S+(o-S)*i;e.setParameterValueById(this._eyeBlinkParameterIds[P],C)}}if(s!=Number.MAX_VALUE)for(var w=0;w<this._lipSyncParameterIds.length&&w<u;++w){var I=e.getParameterValueById(this._lipSyncParameterIds[w]);if(!(l>>w&1)){var L=I+(s-I)*i;e.setParameterValueById(this._lipSyncParameterIds[w],L)}}for(;d<this._motionData.curveCount&&v[d].type==it.CubismMotionCurveTarget_PartOpacity;++d)if(c=vt(this._motionData,d,p),r.setOpacityFromMotion)e.setPartOpacityById(v[d].id,c);else{if(-1==(f=e.getParameterIndex(v[d].id)))continue;e.setParameterValueByIndex(f,c)}a>=this._motionData.duration&&(this._isLoop?(n.setStartTime(t),this._isLoopFadeIn&&n.setFadeInStartTime(t)):(this._onFinishedMotion&&this._onFinishedMotion(this),n.setIsFinished(!0))),this._lastWeight=i}},{key:"setIsLoop",value:function(e){this._isLoop=e}},{key:"isLoop",value:function(){return this._isLoop}},{key:"setIsLoopFadeIn",value:function(e){this._isLoopFadeIn=e}},{key:"isLoopFadeIn",value:function(){return this._isLoopFadeIn}},{key:"getDuration",value:function(){return this._isLoop?-1:this._loopDurationSeconds}},{key:"getLoopDuration",value:function(){return this._loopDurationSeconds}},{key:"setParameterFadeInTime",value:function(e,t){for(var i=this._motionData.curves,r=0;r<this._motionData.curveCount;++r)if(e==i[r].id)return void(i[r].fadeInTime=t)}},{key:"setParameterFadeOutTime",value:function(e,t){for(var i=this._motionData.curves,r=0;r<this._motionData.curveCount;++r)if(e==i[r].id)return void(i[r].fadeOutTime=t)}},{key:"getParameterFadeInTime",value:function(e){for(var t=this._motionData.curves,i=0;i<this._motionData.curveCount;++i)if(e==t[i].id)return t[i].fadeInTime;return-1}},{key:"getParameterFadeOutTime",value:function(e){for(var t=this._motionData.curves,i=0;i<this._motionData.curveCount;++i)if(e==t[i].id)return t[i].fadeOutTime;return-1}},{key:"setEffectIds",value:function(e,t){this._eyeBlinkParameterIds=e,this._lipSyncParameterIds=t}},{key:"release",value:function(){this._motionData=void 0}},{key:"parse",value:function(e){this._motionData=new ut;var t=new lt(e);this._motionData.duration=t.getMotionDuration(),this._motionData.loop=t.isMotionLoop(),this._motionData.curveCount=t.getMotionCurveCount(),this._motionData.fps=t.getMotionFps(),this._motionData.eventCount=t.getEventCount();var i=t.getEvaluationOptionFlag(ht.EvaluationOptionFlag_AreBeziersRistricted),r=t.getMotionFadeInTime(),n=t.getMotionFadeOutTime();this._fadeInSeconds=void 0!==r?r<0?1:r:1,this._fadeOutSeconds=void 0!==n?n<0?1:n:1,this._motionData.curves=Array.from({length:this._motionData.curveCount}).map((function(){return new st})),this._motionData.segments=Array.from({length:t.getMotionTotalSegmentCount()}).map((function(){return new at})),this._motionData.events=Array.from({length:this._motionData.eventCount}).map((function(){return new ot})),this._motionData.points=[];for(var a=0,s=0,o=0;o<this._motionData.curveCount;++o){var u=this._motionData.curves[o];switch(t.getMotionCurveTarget(o)){case"Model":u.type=it.CubismMotionCurveTarget_Model;break;case"Parameter":u.type=it.CubismMotionCurveTarget_Parameter;break;case"PartOpacity":u.type=it.CubismMotionCurveTarget_PartOpacity;break;default:ze('Warning : Unable to get segment type from Curve! The number of "CurveCount" may be incorrect!')}u.id=t.getMotionCurveId(o),u.baseSegmentIndex=s;var l=t.getMotionCurveFadeInTime(o),h=t.getMotionCurveFadeOutTime(o);u.fadeInTime=void 0!==l?l:-1,u.fadeOutTime=void 0!==h?h:-1;for(var c=0;c<t.getMotionCurveSegmentCount(o);){switch(0==c?(this._motionData.segments[s].basePointIndex=a,this._motionData.points[a]=new nt(t.getMotionCurveSegment(o,c),t.getMotionCurveSegment(o,c+1)),a+=1,c+=2):this._motionData.segments[s].basePointIndex=a-1,t.getMotionCurveSegment(o,c)){case rt.CubismMotionSegmentType_Linear:this._motionData.segments[s].segmentType=rt.CubismMotionSegmentType_Linear,this._motionData.segments[s].evaluate=dt,this._motionData.points[a]=new nt(t.getMotionCurveSegment(o,c+1),t.getMotionCurveSegment(o,c+2)),a+=1,c+=3;break;case rt.CubismMotionSegmentType_Bezier:this._motionData.segments[s].segmentType=rt.CubismMotionSegmentType_Bezier,this._motionData.segments[s].evaluate=i?ft:gt,this._motionData.points[a]=new nt(t.getMotionCurveSegment(o,c+1),t.getMotionCurveSegment(o,c+2)),this._motionData.points[a+1]=new nt(t.getMotionCurveSegment(o,c+3),t.getMotionCurveSegment(o,c+4)),this._motionData.points[a+2]=new nt(t.getMotionCurveSegment(o,c+5),t.getMotionCurveSegment(o,c+6)),a+=3,c+=7;break;case rt.CubismMotionSegmentType_Stepped:this._motionData.segments[s].segmentType=rt.CubismMotionSegmentType_Stepped,this._motionData.segments[s].evaluate=mt,this._motionData.points[a]=new nt(t.getMotionCurveSegment(o,c+1),t.getMotionCurveSegment(o,c+2)),a+=1,c+=3;break;case rt.CubismMotionSegmentType_InverseStepped:this._motionData.segments[s].segmentType=rt.CubismMotionSegmentType_InverseStepped,this._motionData.segments[s].evaluate=pt,this._motionData.points[a]=new nt(t.getMotionCurveSegment(o,c+1),t.getMotionCurveSegment(o,c+2)),a+=1,c+=3}++u.segmentCount,++s}this._motionData.curves.push(u)}for(var d=0;d<t.getEventCount();++d)this._motionData.events[d].fireTime=t.getEventTime(d),this._motionData.events[d].value=t.getEventValue(d);t.release()}},{key:"getFiredEvent",value:function(e,t){this._firedEventValues.length=0;for(var i=0;i<this._motionData.eventCount;++i)this._motionData.events[i].fireTime>e&&this._motionData.events[i].fireTime<=t&&this._firedEventValues.push(this._motionData.events[i].value);return this._firedEventValues}}],[{key:"create",value:function(e,t){var r=new i;return r.parse(e),r._sourceFrameRate=r._motionData.fps,r._loopDurationSeconds=r._motionData.duration,r._onFinishedMotion=t,r}}]),i}(Ye),yt=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r){var n,a;return(0,o.Z)(this,i),(n=t.call(this,e,r)).groups={idle:"Idle"},n.motionDataType="json",n.queueManager=new Qe,n.definitions=null!=(a=e.motions)?a:{},n.eyeBlinkIds=e.getEyeBlinkParameters()||[],n.lipSyncIds=e.getLipSyncParameters()||[],n.init(r),n}return(0,u.Z)(i,[{key:"init",value:function(e){var t=this;(0,f.Z)((0,g.Z)(i.prototype),"init",this).call(this,e),this.settings.expressions&&(this.expressionManager=new $e(this.settings,e)),this.queueManager.setEventCallback((function(e,i,r){t.emit("motion:"+i)}))}},{key:"isFinished",value:function(){return this.queueManager.isFinished()}},{key:"_startMotion",value:function(e,t){return e.setFinishedMotionHandler(t),this.queueManager.stopAllMotions(),this.queueManager.startMotion(e,!1,performance.now())}},{key:"_stopAllMotions",value:function(){this.queueManager.stopAllMotions()}},{key:"createMotion",value:function(e,t,i){var r=_t.create(e),n=new lt(e),s=(t===this.groups.idle?a.idleMotionFadingDuration:a.motionFadingDuration)/1e3;return void 0===n.getMotionFadeInTime()&&r.setFadeInTime(i.FadeInTime>0?i.FadeInTime:s),void 0===n.getMotionFadeOutTime()&&r.setFadeOutTime(i.FadeOutTime>0?i.FadeOutTime:s),r.setEffectIds(this.eyeBlinkIds,this.lipSyncIds),r}},{key:"getMotionFile",value:function(e){return e.File}},{key:"getMotionName",value:function(e){return e.File}},{key:"getSoundFile",value:function(e){return e.Sound}},{key:"updateParameters",value:function(e,t){return this.queueManager.doUpdateMotion(e,t)}},{key:"destroy",value:function(){(0,f.Z)((0,g.Z)(i.prototype),"destroy",this).call(this),this.queueManager.release(),this.queueManager=void 0}}]),i}(U),xt=function(){function e(){(0,o.Z)(this,e),this._breathParameters=[],this._currentTime=0}return(0,u.Z)(e,[{key:"setParameters",value:function(e){this._breathParameters=e}},{key:"getParameters",value:function(){return this._breathParameters}},{key:"updateParameters",value:function(e,t){this._currentTime+=t;for(var i=2*this._currentTime*3.14159,r=0;r<this._breathParameters.length;++r){var n=this._breathParameters[r];e.addParameterValueById(n.parameterId,n.offset+n.peak*Math.sin(i/n.cycle),n.weight)}}}],[{key:"create",value:function(){return new e}}]),e}(),kt=(0,u.Z)((function e(t,i,r,n,a){(0,o.Z)(this,e),this.parameterId=void 0==t?void 0:t,this.offset=void 0==i?0:i,this.peak=void 0==r?0:r,this.cycle=void 0==n?0:n,this.weight=void 0==a?0:a})),Mt=function(){function e(t){var i,r;(0,o.Z)(this,e),this._blinkingState=wt.EyeState_First,this._nextBlinkingTime=0,this._stateStartTimeSeconds=0,this._blinkingIntervalSeconds=4,this._closingSeconds=.1,this._closedSeconds=.05,this._openingSeconds=.15,this._userTimeSeconds=0,this._parameterIds=[],null!=t&&(this._parameterIds=null!=(r=null==(i=t.getEyeBlinkParameters())?void 0:i.slice())?r:this._parameterIds)}return(0,u.Z)(e,[{key:"setBlinkingInterval",value:function(e){this._blinkingIntervalSeconds=e}},{key:"setBlinkingSetting",value:function(e,t,i){this._closingSeconds=e,this._closedSeconds=t,this._openingSeconds=i}},{key:"setParameterIds",value:function(e){this._parameterIds=e}},{key:"getParameterIds",value:function(){return this._parameterIds}},{key:"updateParameters",value:function(t,i){var r;this._userTimeSeconds+=i;var n=0;switch(this._blinkingState){case wt.EyeState_Closing:(n=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closingSeconds)>=1&&(n=1,this._blinkingState=wt.EyeState_Closed,this._stateStartTimeSeconds=this._userTimeSeconds),r=1-n;break;case wt.EyeState_Closed:(n=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closedSeconds)>=1&&(this._blinkingState=wt.EyeState_Opening,this._stateStartTimeSeconds=this._userTimeSeconds),r=0;break;case wt.EyeState_Opening:(n=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._openingSeconds)>=1&&(n=1,this._blinkingState=wt.EyeState_Interval,this._nextBlinkingTime=this.determinNextBlinkingTiming()),r=n;break;case wt.EyeState_Interval:this._nextBlinkingTime<this._userTimeSeconds&&(this._blinkingState=wt.EyeState_Closing,this._stateStartTimeSeconds=this._userTimeSeconds),r=1;break;case wt.EyeState_First:default:this._blinkingState=wt.EyeState_Interval,this._nextBlinkingTime=this.determinNextBlinkingTiming(),r=1}e.CloseIfZero||(r=-r);for(var a=0;a<this._parameterIds.length;++a)t.setParameterValueById(this._parameterIds[a],r)}},{key:"determinNextBlinkingTiming",value:function(){var e=Math.random();return this._userTimeSeconds+e*(2*this._blinkingIntervalSeconds-1)}}],[{key:"create",value:function(t){return new e(t)}}]),e}(),bt=Mt;bt.CloseIfZero=!0;var Pt,St,Ct,wt=function(e){return e[e.EyeState_First=0]="EyeState_First",e[e.EyeState_Interval=1]="EyeState_Interval",e[e.EyeState_Closing=2]="EyeState_Closing",e[e.EyeState_Closed=3]="EyeState_Closed",e[e.EyeState_Opening=4]="EyeState_Opening",e}(wt||{}),It=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;(0,o.Z)(this,e),this.x=t,this.y=i,this.width=r,this.height=n}return(0,u.Z)(e,[{key:"getCenterX",value:function(){return this.x+.5*this.width}},{key:"getCenterY",value:function(){return this.y+.5*this.height}},{key:"getRight",value:function(){return this.x+this.width}},{key:"getBottom",value:function(){return this.y+this.height}},{key:"setRect",value:function(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height}},{key:"expand",value:function(e,t){this.x-=e,this.y-=t,this.width+=2*e,this.height+=2*t}}]),e}(),Lt=function(){function e(){(0,o.Z)(this,e),this._maskRenderTexture=null,this._colorBuffer=null,this._currentFrameNo=0,this._clippingMaskBufferSize=256,this._clippingContextListForMask=[],this._clippingContextListForDraw=[],this._channelColors=[],this._tmpBoundsOnModel=new It,this._tmpMatrix=new Ee,this._tmpMatrixForMask=new Ee,this._tmpMatrixForDraw=new Ee;var t=new Ae;t.R=1,t.G=0,t.B=0,t.A=0,this._channelColors.push(t),(t=new Ae).R=0,t.G=1,t.B=0,t.A=0,this._channelColors.push(t),(t=new Ae).R=0,t.G=0,t.B=1,t.A=0,this._channelColors.push(t),(t=new Ae).R=0,t.G=0,t.B=0,t.A=1,this._channelColors.push(t)}return(0,u.Z)(e,[{key:"getChannelFlagAsColor",value:function(e){return this._channelColors[e]}},{key:"getMaskRenderTexture",value:function(){var e=0;if(this._maskTexture&&0!=this._maskTexture.texture&&(this._maskTexture.frameNo=this._currentFrameNo,e=this._maskTexture.texture),0==e){var t=this._clippingMaskBufferSize;this._colorBuffer=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this._colorBuffer),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.bindTexture(this.gl.TEXTURE_2D,null),e=this.gl.createFramebuffer(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this._colorBuffer,0),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,Ct),this._maskTexture=new Tt(this._currentFrameNo,e)}return e}},{key:"setGL",value:function(e){this.gl=e}},{key:"calcClippedDrawTotalBounds",value:function(e,t){for(var i=Number.MAX_VALUE,r=Number.MAX_VALUE,n=Number.MIN_VALUE,a=Number.MIN_VALUE,s=t._clippedDrawableIndexList.length,o=0;o<s;o++){for(var u=t._clippedDrawableIndexList[o],l=e.getDrawableVertexCount(u),h=e.getDrawableVertices(u),c=Number.MAX_VALUE,d=Number.MAX_VALUE,f=Number.MIN_VALUE,g=Number.MIN_VALUE,m=l*Ue,p=Ze;p<m;p+=Ue){var v=h[p],_=h[p+1];v<c&&(c=v),v>f&&(f=v),_<d&&(d=_),_>g&&(g=_)}if(c!=Number.MAX_VALUE)if(c<i&&(i=c),d<r&&(r=d),f>n&&(n=f),g>a&&(a=g),i==Number.MAX_VALUE)t._allClippedDrawRect.x=0,t._allClippedDrawRect.y=0,t._allClippedDrawRect.width=0,t._allClippedDrawRect.height=0,t._isUsing=!1;else{t._isUsing=!0;var y=n-i,x=a-r;t._allClippedDrawRect.x=i,t._allClippedDrawRect.y=r,t._allClippedDrawRect.width=y,t._allClippedDrawRect.height=x}}}},{key:"release",value:function(){for(var e,t,i,r=this,n=0;n<this._clippingContextListForMask.length;n++)this._clippingContextListForMask[n]&&(null==(e=this._clippingContextListForMask[n])||e.release());r._clippingContextListForMask=void 0,r._clippingContextListForDraw=void 0,this._maskTexture&&(null==(t=this.gl)||t.deleteFramebuffer(this._maskTexture.texture),r._maskTexture=void 0),r._channelColors=void 0,null==(i=this.gl)||i.deleteTexture(this._colorBuffer),this._colorBuffer=null}},{key:"initialize",value:function(e,t,i,r){for(var n=0;n<t;n++)if(r[n]<=0)this._clippingContextListForDraw.push(null);else{var a=this.findSameClip(i[n],r[n]);null==a&&(a=new Et(this,i[n],r[n]),this._clippingContextListForMask.push(a)),a.addClippedDrawable(n),this._clippingContextListForDraw.push(a)}}},{key:"setupClippingContext",value:function(e,t){this._currentFrameNo++;for(var i=0,r=0;r<this._clippingContextListForMask.length;r++){var n=this._clippingContextListForMask[r];this.calcClippedDrawTotalBounds(e,n),n._isUsing&&i++}if(i>0){this.gl.viewport(0,0,this._clippingMaskBufferSize,this._clippingMaskBufferSize),this._maskRenderTexture=this.getMaskRenderTexture(),t.getMvpMatrix(),t.preDraw(),this.setupLayoutBounds(i),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._maskRenderTexture),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(var a=0;a<this._clippingContextListForMask.length;a++){var s=this._clippingContextListForMask[a],o=s._allClippedDrawRect,u=s._layoutBounds;this._tmpBoundsOnModel.setRect(o),this._tmpBoundsOnModel.expand(.05*o.width,.05*o.height);var l=u.width/this._tmpBoundsOnModel.width,h=u.height/this._tmpBoundsOnModel.height;this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(-1,-1),this._tmpMatrix.scaleRelative(2,2),this._tmpMatrix.translateRelative(u.x,u.y),this._tmpMatrix.scaleRelative(l,h),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForMask.setMatrix(this._tmpMatrix.getArray()),this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(u.x,u.y),this._tmpMatrix.scaleRelative(l,h),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForDraw.setMatrix(this._tmpMatrix.getArray()),s._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),s._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray());for(var c=s._clippingIdCount,d=0;d<c;d++){var f=s._clippingIdList[d];e.getDrawableDynamicFlagVertexPositionsDidChange(f)&&(t.setIsCulling(0!=e.getDrawableCulling(f)),t.setClippingContextBufferForMask(s),t.drawMesh(e.getDrawableTextureIndices(f),e.getDrawableVertexIndexCount(f),e.getDrawableVertexCount(f),e.getDrawableVertexIndices(f),e.getDrawableVertices(f),e.getDrawableVertexUvs(f),e.getDrawableOpacity(f),De.CubismBlendMode_Normal,!1))}}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,Ct),t.setClippingContextBufferForMask(null),this.gl.viewport(St[0],St[1],St[2],St[3])}}},{key:"findSameClip",value:function(e,t){for(var i=0;i<this._clippingContextListForMask.length;i++){var r=this._clippingContextListForMask[i],n=r._clippingIdCount;if(n==t){for(var a=0,s=0;s<n;s++)for(var o=r._clippingIdList[s],u=0;u<n;u++)if(e[u]==o){a++;break}if(a==n)return r}}return null}},{key:"setupLayoutBounds",value:function(e){var t=e/4,i=e%4;t=~~t,i=~~i;for(var n=0,a=0;a<4;a++){var s=t+(a<i?1:0);if(0==s);else if(1==s){var o=this._clippingContextListForMask[n++];o._layoutChannelNo=a,o._layoutBounds.x=0,o._layoutBounds.y=0,o._layoutBounds.width=1,o._layoutBounds.height=1}else if(2==s)for(var u=0;u<s;u++){var l=u%2;l=~~l;var h=this._clippingContextListForMask[n++];h._layoutChannelNo=a,h._layoutBounds.x=.5*l,h._layoutBounds.y=0,h._layoutBounds.width=.5,h._layoutBounds.height=1}else if(s<=4)for(var c=0;c<s;c++){var d=c%2,f=c/2;d=~~d,f=~~f;var g=this._clippingContextListForMask[n++];g._layoutChannelNo=a,g._layoutBounds.x=.5*d,g._layoutBounds.y=.5*f,g._layoutBounds.width=.5,g._layoutBounds.height=.5}else if(s<=9)for(var m=0;m<s;m++){var p=m%3,v=m/3;p=~~p,v=~~v;var _=this._clippingContextListForMask[n++];_._layoutChannelNo=a,_._layoutBounds.x=p/3,_._layoutBounds.y=v/3,_._layoutBounds.width=1/3,_._layoutBounds.height=1/3}else if(r.supportMoreMaskDivisions&&s<=16)for(var y=0;y<s;y++){var x=y%4,k=y/4;x=~~x,k=~~k;var M=this._clippingContextListForMask[n++];M._layoutChannelNo=a,M._layoutBounds.x=x/4,M._layoutBounds.y=k/4,M._layoutBounds.width=1/4,M._layoutBounds.height=1/4}else Xe("not supported mask count : {0}",s)}}},{key:"getColorBuffer",value:function(){return this._colorBuffer}},{key:"getClippingContextListForDraw",value:function(){return this._clippingContextListForDraw}},{key:"setClippingMaskBufferSize",value:function(e){this._clippingMaskBufferSize=e}},{key:"getClippingMaskBufferSize",value:function(){return this._clippingMaskBufferSize}}]),e}(),Tt=(0,u.Z)((function e(t,i){(0,o.Z)(this,e),this.frameNo=t,this.texture=i})),Et=function(){function e(t,i,r){(0,o.Z)(this,e),this._isUsing=!1,this._owner=t,this._clippingIdList=i,this._clippingIdCount=r,this._allClippedDrawRect=new It,this._layoutBounds=new It,this._clippedDrawableIndexList=[],this._matrixForMask=new Ee,this._matrixForDraw=new Ee}return(0,u.Z)(e,[{key:"release",value:function(){var e=this;e._layoutBounds=void 0,e._allClippedDrawRect=void 0,e._clippedDrawableIndexList=void 0}},{key:"addClippedDrawable",value:function(e){this._clippedDrawableIndexList.push(e)}},{key:"getClippingManager",value:function(){return this._owner}},{key:"setGl",value:function(e){this._owner.setGL(e)}}]),e}(),Ft=function(){function e(){(0,o.Z)(this,e),this._shaderSets=[]}return(0,u.Z)(e,[{key:"release",value:function(){this.releaseShaderProgram()}},{key:"setupShaderProgram",value:function(e,t,i,r,n,a,s,o,u,l,h,c,d){var f,g,m,p;h||Xe("NoPremultipliedAlpha is not allowed"),0==this._shaderSets.length&&this.generateShaders();var v=e.getClippingContextBufferForMask();if(null!=v){var _=this._shaderSets[Dt.ShaderNames_SetupMask];this.gl.useProgram(_.shaderProgram),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(_.samplerTexture0Location,0),null==s.vertex&&(s.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(_.attributePositionLocation),this.gl.vertexAttribPointer(_.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),null==s.uv&&(s.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,a,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(_.attributeTexCoordLocation),this.gl.vertexAttribPointer(_.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0);var y=v._layoutChannelNo,x=v.getClippingManager().getChannelFlagAsColor(y);this.gl.uniform4f(_.uniformChannelFlagLocation,x.R,x.G,x.B,x.A),this.gl.uniformMatrix4fv(_.uniformClipMatrixLocation,!1,v._matrixForMask.getArray());var k=v._layoutBounds;this.gl.uniform4f(_.uniformBaseColorLocation,2*k.x-1,2*k.y-1,2*k.getRight()-1,2*k.getBottom()-1),f=this.gl.ZERO,g=this.gl.ONE_MINUS_SRC_COLOR,m=this.gl.ZERO,p=this.gl.ONE_MINUS_SRC_ALPHA}else{var M,b=e.getClippingContextBufferForDraw(),P=null!=b?d?2:1:0;switch(u){case De.CubismBlendMode_Normal:default:M=this._shaderSets[Dt.ShaderNames_NormalPremultipliedAlpha+P],f=this.gl.ONE,g=this.gl.ONE_MINUS_SRC_ALPHA,m=this.gl.ONE,p=this.gl.ONE_MINUS_SRC_ALPHA;break;case De.CubismBlendMode_Additive:M=this._shaderSets[Dt.ShaderNames_AddPremultipliedAlpha+P],f=this.gl.ONE,g=this.gl.ONE,m=this.gl.ZERO,p=this.gl.ONE;break;case De.CubismBlendMode_Multiplicative:M=this._shaderSets[Dt.ShaderNames_MultPremultipliedAlpha+P],f=this.gl.DST_COLOR,g=this.gl.ONE_MINUS_SRC_ALPHA,m=this.gl.ZERO,p=this.gl.ONE}if(this.gl.useProgram(M.shaderProgram),null==s.vertex&&(s.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(M.attributePositionLocation),this.gl.vertexAttribPointer(M.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),null==s.uv&&(s.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,s.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,a,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(M.attributeTexCoordLocation),this.gl.vertexAttribPointer(M.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0),null!=b){this.gl.activeTexture(this.gl.TEXTURE1);var S=b.getClippingManager().getColorBuffer();this.gl.bindTexture(this.gl.TEXTURE_2D,S),this.gl.uniform1i(M.samplerTexture1Location,1),this.gl.uniformMatrix4fv(M.uniformClipMatrixLocation,!1,b._matrixForDraw.getArray());var C=b._layoutChannelNo,w=b.getClippingManager().getChannelFlagAsColor(C);this.gl.uniform4f(M.uniformChannelFlagLocation,w.R,w.G,w.B,w.A)}this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(M.samplerTexture0Location,0),this.gl.uniformMatrix4fv(M.uniformMatrixLocation,!1,c.getArray()),this.gl.uniform4f(M.uniformBaseColorLocation,l.R,l.G,l.B,l.A)}null==s.index&&(s.index=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,s.index),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,n,this.gl.DYNAMIC_DRAW),this.gl.blendFuncSeparate(f,g,m,p)}},{key:"releaseShaderProgram",value:function(){for(var e=0;e<this._shaderSets.length;e++)this.gl.deleteProgram(this._shaderSets[e].shaderProgram),this._shaderSets[e].shaderProgram=0;this._shaderSets=[]}},{key:"generateShaders",value:function(){for(var e=0;e<10;e++)this._shaderSets.push({});this._shaderSets[0].shaderProgram=this.loadShaderProgram(At,Rt),this._shaderSets[1].shaderProgram=this.loadShaderProgram(Bt,Zt),this._shaderSets[2].shaderProgram=this.loadShaderProgram(Ot,Ut),this._shaderSets[3].shaderProgram=this.loadShaderProgram(Ot,Nt),this._shaderSets[4].shaderProgram=this._shaderSets[1].shaderProgram,this._shaderSets[5].shaderProgram=this._shaderSets[2].shaderProgram,this._shaderSets[6].shaderProgram=this._shaderSets[3].shaderProgram,this._shaderSets[7].shaderProgram=this._shaderSets[1].shaderProgram,this._shaderSets[8].shaderProgram=this._shaderSets[2].shaderProgram,this._shaderSets[9].shaderProgram=this._shaderSets[3].shaderProgram,this._shaderSets[0].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[0].shaderProgram,"a_position"),this._shaderSets[0].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[0].shaderProgram,"a_texCoord"),this._shaderSets[0].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[0].shaderProgram,"s_texture0"),this._shaderSets[0].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[0].shaderProgram,"u_clipMatrix"),this._shaderSets[0].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[0].shaderProgram,"u_channelFlag"),this._shaderSets[0].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[0].shaderProgram,"u_baseColor"),this._shaderSets[1].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[1].shaderProgram,"a_position"),this._shaderSets[1].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[1].shaderProgram,"a_texCoord"),this._shaderSets[1].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[1].shaderProgram,"s_texture0"),this._shaderSets[1].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[1].shaderProgram,"u_matrix"),this._shaderSets[1].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[1].shaderProgram,"u_baseColor"),this._shaderSets[2].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[2].shaderProgram,"a_position"),this._shaderSets[2].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[2].shaderProgram,"a_texCoord"),this._shaderSets[2].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"s_texture0"),this._shaderSets[2].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"s_texture1"),this._shaderSets[2].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"u_matrix"),this._shaderSets[2].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"u_clipMatrix"),this._shaderSets[2].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"u_channelFlag"),this._shaderSets[2].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"u_baseColor"),this._shaderSets[3].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[3].shaderProgram,"a_position"),this._shaderSets[3].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[3].shaderProgram,"a_texCoord"),this._shaderSets[3].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"s_texture0"),this._shaderSets[3].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"s_texture1"),this._shaderSets[3].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"u_matrix"),this._shaderSets[3].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"u_clipMatrix"),this._shaderSets[3].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"u_channelFlag"),this._shaderSets[3].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"u_baseColor"),this._shaderSets[4].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[4].shaderProgram,"a_position"),this._shaderSets[4].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[4].shaderProgram,"a_texCoord"),this._shaderSets[4].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[4].shaderProgram,"s_texture0"),this._shaderSets[4].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[4].shaderProgram,"u_matrix"),this._shaderSets[4].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[4].shaderProgram,"u_baseColor"),this._shaderSets[5].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[5].shaderProgram,"a_position"),this._shaderSets[5].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[5].shaderProgram,"a_texCoord"),this._shaderSets[5].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"s_texture0"),this._shaderSets[5].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"s_texture1"),this._shaderSets[5].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"u_matrix"),this._shaderSets[5].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"u_clipMatrix"),this._shaderSets[5].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"u_channelFlag"),this._shaderSets[5].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"u_baseColor"),this._shaderSets[6].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[6].shaderProgram,"a_position"),this._shaderSets[6].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[6].shaderProgram,"a_texCoord"),this._shaderSets[6].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"s_texture0"),this._shaderSets[6].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"s_texture1"),this._shaderSets[6].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"u_matrix"),this._shaderSets[6].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"u_clipMatrix"),this._shaderSets[6].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"u_channelFlag"),this._shaderSets[6].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"u_baseColor"),this._shaderSets[7].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[7].shaderProgram,"a_position"),this._shaderSets[7].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[7].shaderProgram,"a_texCoord"),this._shaderSets[7].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[7].shaderProgram,"s_texture0"),this._shaderSets[7].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[7].shaderProgram,"u_matrix"),this._shaderSets[7].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[7].shaderProgram,"u_baseColor"),this._shaderSets[8].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[8].shaderProgram,"a_position"),this._shaderSets[8].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[8].shaderProgram,"a_texCoord"),this._shaderSets[8].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"s_texture0"),this._shaderSets[8].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"s_texture1"),this._shaderSets[8].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"u_matrix"),this._shaderSets[8].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"u_clipMatrix"),this._shaderSets[8].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"u_channelFlag"),this._shaderSets[8].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"u_baseColor"),this._shaderSets[9].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[9].shaderProgram,"a_position"),this._shaderSets[9].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[9].shaderProgram,"a_texCoord"),this._shaderSets[9].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"s_texture0"),this._shaderSets[9].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"s_texture1"),this._shaderSets[9].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"u_matrix"),this._shaderSets[9].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"u_clipMatrix"),this._shaderSets[9].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"u_channelFlag"),this._shaderSets[9].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"u_baseColor")}},{key:"loadShaderProgram",value:function(e,t){var i=this.gl.createProgram(),r=this.compileShaderSource(this.gl.VERTEX_SHADER,e);if(!r)return Xe("Vertex shader compile error!"),0;var n=this.compileShaderSource(this.gl.FRAGMENT_SHADER,t);return n?(this.gl.attachShader(i,r),this.gl.attachShader(i,n),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)?(this.gl.deleteShader(r),this.gl.deleteShader(n),i):(Xe("Failed to link program: {0}",i),this.gl.deleteShader(r),this.gl.deleteShader(n),i&&this.gl.deleteProgram(i),0)):(Xe("Vertex shader compile error!"),0)}},{key:"compileShaderSource",value:function(e,t){var i=t,r=this.gl.createShader(e);(this.gl.shaderSource(r,i),this.gl.compileShader(r),r)||Xe("Shader compile log: {0} ",this.gl.getShaderInfoLog(r));return this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)?r:(this.gl.deleteShader(r),null)}},{key:"setGl",value:function(e){this.gl=e}}],[{key:"getInstance",value:function(){return null==Pt?Pt=new e:Pt}},{key:"deleteInstance",value:function(){Pt&&(Pt.release(),Pt=void 0)}}]),e}(),Dt=function(e){return e[e.ShaderNames_SetupMask=0]="ShaderNames_SetupMask",e[e.ShaderNames_NormalPremultipliedAlpha=1]="ShaderNames_NormalPremultipliedAlpha",e[e.ShaderNames_NormalMaskedPremultipliedAlpha=2]="ShaderNames_NormalMaskedPremultipliedAlpha",e[e.ShaderNames_NomralMaskedInvertedPremultipliedAlpha=3]="ShaderNames_NomralMaskedInvertedPremultipliedAlpha",e[e.ShaderNames_AddPremultipliedAlpha=4]="ShaderNames_AddPremultipliedAlpha",e[e.ShaderNames_AddMaskedPremultipliedAlpha=5]="ShaderNames_AddMaskedPremultipliedAlpha",e[e.ShaderNames_AddMaskedPremultipliedAlphaInverted=6]="ShaderNames_AddMaskedPremultipliedAlphaInverted",e[e.ShaderNames_MultPremultipliedAlpha=7]="ShaderNames_MultPremultipliedAlpha",e[e.ShaderNames_MultMaskedPremultipliedAlpha=8]="ShaderNames_MultMaskedPremultipliedAlpha",e[e.ShaderNames_MultMaskedPremultipliedAlphaInverted=9]="ShaderNames_MultMaskedPremultipliedAlphaInverted",e}(Dt||{}),At="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_myPos;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_clipMatrix * a_position;   v_myPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Rt="precision mediump float;varying vec2       v_texCoord;varying vec4       v_myPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;void main(){   float isInside =        step(u_baseColor.x, v_myPos.x/v_myPos.w)       * step(u_baseColor.y, v_myPos.y/v_myPos.w)       * step(v_myPos.x/v_myPos.w, u_baseColor.z)       * step(v_myPos.y/v_myPos.w, u_baseColor.w);   gl_FragColor = u_channelFlag * texture2D(s_texture0, v_texCoord).a * isInside;}",Bt="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;uniform mat4       u_matrix;void main(){   gl_Position = u_matrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Ot="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform mat4       u_matrix;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_matrix * a_position;   v_clipPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Zt="precision mediump float;varying vec2       v_texCoord;uniform vec4       u_baseColor;uniform sampler2D  s_texture0;void main(){   gl_FragColor = texture2D(s_texture0 , v_texCoord) * u_baseColor;}",Ut="precision mediump float;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;uniform sampler2D  s_texture1;void main(){   vec4 col_formask = texture2D(s_texture0 , v_texCoord) * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * maskVal;   gl_FragColor = col_formask;}",Nt="precision mediump float;varying vec2 v_texCoord;varying vec4 v_clipPos;uniform sampler2D s_texture0;uniform sampler2D s_texture1;uniform vec4 u_channelFlag;uniform vec4 u_baseColor;void main(){vec4 col_formask = texture2D(s_texture0, v_texCoord) * u_baseColor;vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;col_formask = col_formask * (1.0 - maskVal);gl_FragColor = col_formask;}",Vt=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(){var e;return(0,o.Z)(this,i),(e=t.call(this))._clippingContextBufferForMask=null,e._clippingContextBufferForDraw=null,e._clippingManager=new Lt,e.firstDraw=!0,e._textures={},e._sortedDrawableIndexList=[],e._bufferData={vertex:null,uv:null,index:null},e}return(0,u.Z)(i,[{key:"initialize",value:function(e){e.isUsingMasking()&&(this._clippingManager=new Lt,this._clippingManager.initialize(e,e.getDrawableCount(),e.getDrawableMasks(),e.getDrawableMaskCounts()));for(var t=e.getDrawableCount()-1;t>=0;t--)this._sortedDrawableIndexList[t]=0;(0,f.Z)((0,g.Z)(i.prototype),"initialize",this).call(this,e)}},{key:"bindTexture",value:function(e,t){this._textures[e]=t}},{key:"getBindedTextures",value:function(){return this._textures}},{key:"setClippingMaskBufferSize",value:function(e){this._clippingManager.release(),this._clippingManager=new Lt,this._clippingManager.setClippingMaskBufferSize(e),this._clippingManager.initialize(this.getModel(),this.getModel().getDrawableCount(),this.getModel().getDrawableMasks(),this.getModel().getDrawableMaskCounts())}},{key:"getClippingMaskBufferSize",value:function(){return this._clippingManager.getClippingMaskBufferSize()}},{key:"release",value:function(){var e,t,i,r=this;this._clippingManager.release(),r._clippingManager=void 0,null==(e=this.gl)||e.deleteBuffer(this._bufferData.vertex),this._bufferData.vertex=null,null==(t=this.gl)||t.deleteBuffer(this._bufferData.uv),this._bufferData.uv=null,null==(i=this.gl)||i.deleteBuffer(this._bufferData.index),this._bufferData.index=null,r._bufferData=void 0,r._textures=void 0}},{key:"doDrawModel",value:function(){this.preDraw(),null!=this._clippingManager&&this._clippingManager.setupClippingContext(this.getModel(),this);for(var e=this.getModel().getDrawableCount(),t=this.getModel().getDrawableRenderOrders(),i=0;i<e;++i){var r=t[i];this._sortedDrawableIndexList[r]=i}for(var n=0;n<e;++n){var a=this._sortedDrawableIndexList[n];this.getModel().getDrawableDynamicFlagIsVisible(a)&&(this.setClippingContextBufferForDraw(null!=this._clippingManager?this._clippingManager.getClippingContextListForDraw()[a]:null),this.setIsCulling(this.getModel().getDrawableCulling(a)),this.drawMesh(this.getModel().getDrawableTextureIndices(a),this.getModel().getDrawableVertexIndexCount(a),this.getModel().getDrawableVertexCount(a),this.getModel().getDrawableVertexIndices(a),this.getModel().getDrawableVertices(a),this.getModel().getDrawableVertexUvs(a),this.getModel().getDrawableOpacity(a),this.getModel().getDrawableBlendMode(a),this.getModel().getDrawableInvertedMaskBit(a)))}}},{key:"drawMesh",value:function(e,t,i,r,n,a,s,o,u){this.isCulling()?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CCW);var l=this.getModelColor();null==this.getClippingContextBufferForMask()&&(l.A*=s,this.isPremultipliedAlpha()&&(l.R*=l.A,l.G*=l.A,l.B*=l.A));var h=null;null!=this._textures[e]&&(h=this._textures[e]),Ft.getInstance().setupShaderProgram(this,h,i,n,r,a,this._bufferData,s,o,l,this.isPremultipliedAlpha(),this.getMvpMatrix(),u),this.gl.drawElements(this.gl.TRIANGLES,t,this.gl.UNSIGNED_SHORT,0),this.gl.useProgram(null),this.setClippingContextBufferForDraw(null),this.setClippingContextBufferForMask(null)}},{key:"setRenderState",value:function(e,t){Ct=e,St=t}},{key:"preDraw",value:function(){this.firstDraw&&(this.firstDraw=!1,this._anisortopy=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.BLEND),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}},{key:"setClippingContextBufferForMask",value:function(e){this._clippingContextBufferForMask=e}},{key:"getClippingContextBufferForMask",value:function(){return this._clippingContextBufferForMask}},{key:"setClippingContextBufferForDraw",value:function(e){this._clippingContextBufferForDraw=e}},{key:"getClippingContextBufferForDraw",value:function(){return this._clippingContextBufferForDraw}},{key:"startUp",value:function(e){this.gl=e,this._clippingManager.setGL(e),Ft.getInstance().setGl(e)}}],[{key:"doStaticRelease",value:function(){Ft.deleteInstance()}}]),i}(Fe);Fe.staticRelease=function(){Vt.doStaticRelease()};var jt,Gt=new Ee,zt=function(e){(0,_.Z)(i,e);var t=(0,y.Z)(i);function i(e,r,n){var a;return(0,o.Z)(this,i),(a=t.call(this)).lipSync=!0,a.breath=xt.create(),a.renderer=new Vt,a.idParamAngleX="ParamAngleX",a.idParamAngleY="ParamAngleY",a.idParamAngleZ="ParamAngleZ",a.idParamEyeBallX="ParamEyeBallX",a.idParamEyeBallY="ParamEyeBallY",a.idParamBodyAngleX="ParamBodyAngleX",a.idParamBreath="ParamBreath",a.pixelsPerUnit=1,a.centeringTransform=new k.y3,a.coreModel=e,a.settings=r,a.motionManager=new yt(r,n),a.init(),a}return(0,u.Z)(i,[{key:"init",value:function(){var e;(0,f.Z)((0,g.Z)(i.prototype),"init",this).call(this),(null==(e=this.settings.getEyeBlinkParameters())?void 0:e.length)>0&&(this.eyeBlink=bt.create(this.settings)),this.breath.setParameters([new kt(this.idParamAngleX,0,15,6.5345,.5),new kt(this.idParamAngleY,0,8,3.5345,.5),new kt(this.idParamAngleZ,0,10,5.5345,.5),new kt(this.idParamBodyAngleX,0,4,15.5345,.5),new kt(this.idParamBreath,0,.5,3.2345,.5)]),this.renderer.initialize(this.coreModel),this.renderer.setIsPremultipliedAlpha(!0)}},{key:"getSize",value:function(){return[this.coreModel.getModel().canvasinfo.CanvasWidth,this.coreModel.getModel().canvasinfo.CanvasHeight]}},{key:"getLayout",value:function(){var e={};if(this.settings.layout)for(var t=0,i=Object.keys(this.settings.layout);t<i.length;t++){var r=i[t];e[r.charAt(0).toLowerCase()+r.slice(1)]=this.settings.layout[r]}return e}},{key:"setupLayout",value:function(){(0,f.Z)((0,g.Z)(i.prototype),"setupLayout",this).call(this),this.pixelsPerUnit=this.coreModel.getModel().canvasinfo.PixelsPerUnit,this.centeringTransform.scale(this.pixelsPerUnit,this.pixelsPerUnit).translate(this.originalWidth/2,this.originalHeight/2)}},{key:"updateWebGLContext",value:function(e,t){this.renderer.firstDraw=!0,this.renderer._bufferData={vertex:null,uv:null,index:null},this.renderer.startUp(e),this.renderer._clippingManager._currentFrameNo=t,this.renderer._clippingManager._maskTexture=void 0,Ft.getInstance()._shaderSets=[]}},{key:"bindTexture",value:function(e,t){this.renderer.bindTexture(e,t)}},{key:"getHitAreaDefs",value:function(){var e,t,i=this;return null!=(t=null==(e=this.settings.hitAreas)?void 0:e.map((function(e){return{id:e.Id,name:e.Name,index:i.coreModel.getDrawableIndex(e.Id)}})))?t:[]}},{key:"getDrawableIDs",value:function(){return this.coreModel.getDrawableIds()}},{key:"getDrawableIndex",value:function(e){return this.coreModel.getDrawableIndex(e)}},{key:"getDrawableVertices",value:function(e){if("string"===typeof e&&-1===(e=this.coreModel.getDrawableIndex(e)))throw new TypeError("Unable to find drawable ID: "+e);for(var t=this.coreModel.getDrawableVertices(e).slice(),i=0;i<t.length;i+=2)t[i]=t[i]*this.pixelsPerUnit+this.originalWidth/2,t[i+1]=-t[i+1]*this.pixelsPerUnit+this.originalHeight/2;return t}},{key:"updateTransform",value:function(e){this.drawingMatrix.copyFrom(this.centeringTransform).prepend(this.localTransform).prepend(e)}},{key:"update",value:function(e,t){var r,n,a,s;(0,f.Z)((0,g.Z)(i.prototype),"update",this).call(this,e,t),e/=1e3,t/=1e3;var o=this.coreModel;this.emit("beforeMotionUpdate");var u=this.motionManager.update(this.coreModel,t);this.emit("afterMotionUpdate"),o.saveParameters(),null==(r=this.motionManager.expressionManager)||r.update(o,t),u||null==(n=this.eyeBlink)||n.updateParameters(o,e),this.updateFocus(),this.updateNaturalMovements(1e3*e,1e3*t),null==(a=this.physics)||a.evaluate(o,e),null==(s=this.pose)||s.updateParameters(o,e),this.emit("beforeModelUpdate"),o.update(),o.loadParameters()}},{key:"updateFocus",value:function(){this.coreModel.addParameterValueById(this.idParamEyeBallX,this.focusController.x),this.coreModel.addParameterValueById(this.idParamEyeBallY,this.focusController.y),this.coreModel.addParameterValueById(this.idParamAngleX,30*this.focusController.x),this.coreModel.addParameterValueById(this.idParamAngleY,30*this.focusController.y),this.coreModel.addParameterValueById(this.idParamAngleZ,this.focusController.x*this.focusController.y*-30),this.coreModel.addParameterValueById(this.idParamBodyAngleX,10*this.focusController.x)}},{key:"updateNaturalMovements",value:function(e,t){var i;null==(i=this.breath)||i.updateParameters(this.coreModel,e/1e3)}},{key:"draw",value:function(e){var t=this.drawingMatrix,i=Gt.getArray();i[0]=t.a,i[1]=t.b,i[4]=-t.c,i[5]=-t.d,i[12]=t.tx,i[13]=t.ty,this.renderer.setMvpMatrix(Gt),this.renderer.setRenderState(e.getParameter(e.FRAMEBUFFER_BINDING),this.viewport),this.renderer.drawModel()}},{key:"destroy",value:function(){(0,f.Z)((0,g.Z)(i.prototype),"destroy",this).call(this),this.renderer.release(),this.coreModel.release(),this.renderer=void 0,this.coreModel=void 0}}]),i}(V),Xt=20;var Wt=function(){function e(){(0,o.Z)(this,e),this._fadeTimeSeconds=.5,this._lastModel=void 0,this._partGroups=[],this._partGroupCounts=[]}return(0,u.Z)(e,[{key:"updateParameters",value:function(e,t){e!=this._lastModel&&this.reset(e),this._lastModel=e,t<0&&(t=0);for(var i=0,r=0;r<this._partGroupCounts.length;r++){var n=this._partGroupCounts[r];this.doFade(e,t,i,n),i+=n}this.copyPartOpacities(e)}},{key:"reset",value:function(e){for(var t=0,i=0;i<this._partGroupCounts.length;++i){for(var r=this._partGroupCounts[i],n=t;n<t+r;++n){this._partGroups[n].initialize(e);var a=this._partGroups[n].partIndex,s=this._partGroups[n].parameterIndex;if(!(a<0)){e.setPartOpacityByIndex(a,n==t?1:0),e.setParameterValueByIndex(s,n==t?1:0);for(var o=0;o<this._partGroups[n].link.length;++o)this._partGroups[n].link[o].initialize(e)}}t+=r}}},{key:"copyPartOpacities",value:function(e){for(var t=0;t<this._partGroups.length;++t){var i=this._partGroups[t];if(0!=i.link.length)for(var r=this._partGroups[t].partIndex,n=e.getPartOpacityByIndex(r),a=0;a<i.link.length;++a){var s=i.link[a].partIndex;s<0||e.setPartOpacityByIndex(s,n)}}}},{key:"doFade",value:function(e,t,i,r){for(var n=-1,a=1,s=.5,o=i;o<i+r;++o){var u=this._partGroups[o].partIndex,l=this._partGroups[o].parameterIndex;if(e.getParameterValueByIndex(l)>.001){if(n>=0)break;n=o,a=e.getPartOpacityByIndex(u),(a+=t/this._fadeTimeSeconds)>1&&(a=1)}}n<0&&(n=0,a=1);for(var h=i;h<i+r;++h){var c=this._partGroups[h].partIndex;if(n==h)e.setPartOpacityByIndex(c,a);else{var d=e.getPartOpacityByIndex(c),f=void 0;(1-(f=a<s?-.5*a/s+1:(1-a)*s/.5))*(1-a)>.15&&(f=1-.15/(1-a)),d>f&&(d=f),e.setPartOpacityByIndex(c,d)}}}}],[{key:"create",value:function(t){var i=new e;"number"===typeof t.FadeInTime&&(i._fadeTimeSeconds=t.FadeInTime,i._fadeTimeSeconds<=0&&(i._fadeTimeSeconds=.5));for(var r=t.Groups,n=r.length,a=0;a<n;++a){for(var s=r[a],o=s.length,u=0,l=0;l<o;++l){var h=s[l],c=new Yt;c.partId=h.Id;var d=h.Link;if(d)for(var f=d.length,g=0;g<f;++g){var m=new Yt;m.partId=d[g],c.link.push(m)}i._partGroups.push(c),++u}i._partGroupCounts.push(u)}return i}}]),e}(),Yt=function(){function e(t){(0,o.Z)(this,e),this.parameterIndex=0,this.partIndex=0,this.partId="",this.link=[],void 0!=t&&this.assignment(t)}return(0,u.Z)(e,[{key:"assignment",value:function(e){return this.partId=e.partId,this.link=e.link.map((function(e){return e.clone()})),this}},{key:"initialize",value:function(e){this.parameterIndex=e.getParameterIndex(this.partId),this.partIndex=e.getPartIndex(this.partId),e.setParameterValueByIndex(this.parameterIndex,1)}},{key:"clone",value:function(){var t=new e;return t.partId=this.partId,t.parameterIndex=this.parameterIndex,t.partIndex=this.partIndex,t.link=this.link.map((function(e){return e.clone()})),t}}]),e}(),Ht=function(){function e(t){(0,o.Z)(this,e),this._model=t,this._savedParameters=[],this._parameterIds=[],this._drawableIds=[],this._partIds=[],this._notExistPartId={},this._notExistParameterId={},this._notExistParameterValues={},this._notExistPartOpacities={},this.initialize()}return(0,u.Z)(e,[{key:"update",value:function(){this._model.update(),this._model.drawables.resetDynamicFlags()}},{key:"getCanvasWidth",value:function(){return null==this._model?0:this._model.canvasinfo.CanvasWidth/this._model.canvasinfo.PixelsPerUnit}},{key:"getCanvasHeight",value:function(){return null==this._model?0:this._model.canvasinfo.CanvasHeight/this._model.canvasinfo.PixelsPerUnit}},{key:"saveParameters",value:function(){for(var e=this._model.parameters.count,t=this._savedParameters.length,i=0;i<e;++i)i<t?this._savedParameters[i]=this._parameterValues[i]:this._savedParameters.push(this._parameterValues[i])}},{key:"getModel",value:function(){return this._model}},{key:"getPartIndex",value:function(e){var t,i=this._model.parts.count;for(t=0;t<i;++t)if(e==this._partIds[t])return t;return e in this._notExistPartId?this._notExistPartId[e]:(t=i+this._notExistPartId.length,this._notExistPartId[e]=t,this._notExistPartOpacities[t]=0,t)}},{key:"getPartCount",value:function(){return this._model.parts.count}},{key:"setPartOpacityByIndex",value:function(e,t){e in this._notExistPartOpacities?this._notExistPartOpacities[e]=t:(0<=e&&this.getPartCount(),this._partOpacities[e]=t)}},{key:"setPartOpacityById",value:function(e,t){var i=this.getPartIndex(e);i<0||this.setPartOpacityByIndex(i,t)}},{key:"getPartOpacityByIndex",value:function(e){return e in this._notExistPartOpacities?this._notExistPartOpacities[e]:(0<=e&&this.getPartCount(),this._partOpacities[e])}},{key:"getPartOpacityById",value:function(e){var t=this.getPartIndex(e);return t<0?0:this.getPartOpacityByIndex(t)}},{key:"getParameterIndex",value:function(e){var t,i=this._model.parameters.count;for(t=0;t<i;++t)if(e==this._parameterIds[t])return t;return e in this._notExistParameterId?this._notExistParameterId[e]:(t=this._model.parameters.count+Object.keys(this._notExistParameterId).length,this._notExistParameterId[e]=t,this._notExistParameterValues[t]=0,t)}},{key:"getParameterCount",value:function(){return this._model.parameters.count}},{key:"getParameterMaximumValue",value:function(e){return this._model.parameters.maximumValues[e]}},{key:"getParameterMinimumValue",value:function(e){return this._model.parameters.minimumValues[e]}},{key:"getParameterDefaultValue",value:function(e){return this._model.parameters.defaultValues[e]}},{key:"getParameterValueByIndex",value:function(e){return e in this._notExistParameterValues?this._notExistParameterValues[e]:(0<=e&&this.getParameterCount(),this._parameterValues[e])}},{key:"getParameterValueById",value:function(e){var t=this.getParameterIndex(e);return this.getParameterValueByIndex(t)}},{key:"setParameterValueByIndex",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;e in this._notExistParameterValues?this._notExistParameterValues[e]=1==i?t:this._notExistParameterValues[e]*(1-i)+t*i:(0<=e&&this.getParameterCount(),this._model.parameters.maximumValues[e]<t&&(t=this._model.parameters.maximumValues[e]),this._model.parameters.minimumValues[e]>t&&(t=this._model.parameters.minimumValues[e]),this._parameterValues[e]=1==i?t:this._parameterValues[e]=this._parameterValues[e]*(1-i)+t*i)}},{key:"setParameterValueById",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=this.getParameterIndex(e);this.setParameterValueByIndex(r,t,i)}},{key:"addParameterValueByIndex",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.setParameterValueByIndex(e,this.getParameterValueByIndex(e)+t*i)}},{key:"addParameterValueById",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=this.getParameterIndex(e);this.addParameterValueByIndex(r,t,i)}},{key:"multiplyParameterValueById",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=this.getParameterIndex(e);this.multiplyParameterValueByIndex(r,t,i)}},{key:"multiplyParameterValueByIndex",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.setParameterValueByIndex(e,this.getParameterValueByIndex(e)*(1+(t-1)*i))}},{key:"getDrawableIds",value:function(){return this._drawableIds.slice()}},{key:"getDrawableIndex",value:function(e){for(var t=this._model.drawables.count,i=0;i<t;++i)if(this._drawableIds[i]==e)return i;return-1}},{key:"getDrawableCount",value:function(){return this._model.drawables.count}},{key:"getDrawableId",value:function(e){return this._model.drawables.ids[e]}},{key:"getDrawableRenderOrders",value:function(){return this._model.drawables.renderOrders}},{key:"getDrawableTextureIndices",value:function(e){return this._model.drawables.textureIndices[e]}},{key:"getDrawableDynamicFlagVertexPositionsDidChange",value:function(e){var t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVertexPositionsDidChangeBit(t[e])}},{key:"getDrawableVertexIndexCount",value:function(e){return this._model.drawables.indexCounts[e]}},{key:"getDrawableVertexCount",value:function(e){return this._model.drawables.vertexCounts[e]}},{key:"getDrawableVertices",value:function(e){return this.getDrawableVertexPositions(e)}},{key:"getDrawableVertexIndices",value:function(e){return this._model.drawables.indices[e]}},{key:"getDrawableVertexPositions",value:function(e){return this._model.drawables.vertexPositions[e]}},{key:"getDrawableVertexUvs",value:function(e){return this._model.drawables.vertexUvs[e]}},{key:"getDrawableOpacity",value:function(e){return this._model.drawables.opacities[e]}},{key:"getDrawableCulling",value:function(e){var t=this._model.drawables.constantFlags;return!Live2DCubismCore.Utils.hasIsDoubleSidedBit(t[e])}},{key:"getDrawableBlendMode",value:function(e){var t=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasBlendAdditiveBit(t[e])?De.CubismBlendMode_Additive:Live2DCubismCore.Utils.hasBlendMultiplicativeBit(t[e])?De.CubismBlendMode_Multiplicative:De.CubismBlendMode_Normal}},{key:"getDrawableInvertedMaskBit",value:function(e){var t=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasIsInvertedMaskBit(t[e])}},{key:"getDrawableMasks",value:function(){return this._model.drawables.masks}},{key:"getDrawableMaskCounts",value:function(){return this._model.drawables.maskCounts}},{key:"isUsingMasking",value:function(){for(var e=0;e<this._model.drawables.count;++e)if(!(this._model.drawables.maskCounts[e]<=0))return!0;return!1}},{key:"getDrawableDynamicFlagIsVisible",value:function(e){var t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasIsVisibleBit(t[e])}},{key:"getDrawableDynamicFlagVisibilityDidChange",value:function(e){var t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVisibilityDidChangeBit(t[e])}},{key:"getDrawableDynamicFlagOpacityDidChange",value:function(e){var t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasOpacityDidChangeBit(t[e])}},{key:"getDrawableDynamicFlagRenderOrderDidChange",value:function(e){var t=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasRenderOrderDidChangeBit(t[e])}},{key:"loadParameters",value:function(){var e=this._model.parameters.count,t=this._savedParameters.length;e>t&&(e=t);for(var i=0;i<e;++i)this._parameterValues[i]=this._savedParameters[i]}},{key:"initialize",value:function(){this._parameterValues=this._model.parameters.values,this._partOpacities=this._model.parts.opacities,this._parameterMaximumValues=this._model.parameters.maximumValues,this._parameterMinimumValues=this._model.parameters.minimumValues;for(var e=this._model.parameters.ids,t=this._model.parameters.count,i=0;i<t;++i)this._parameterIds.push(e[i]);for(var r=this._model.parts.ids,n=this._model.parts.count,a=0;a<n;++a)this._partIds.push(r[a]);for(var s=this._model.drawables.ids,o=this._model.drawables.count,u=0;u<o;++u)this._drawableIds.push(s[u])}},{key:"release",value:function(){this._model.release(),this._model=void 0}}]),e}(),qt=function(){function e(t){(0,o.Z)(this,e),this._moc=t,this._modelCount=0}return(0,u.Z)(e,[{key:"createModel",value:function(){var e,t=Live2DCubismCore.Model.fromMoc(this._moc);if(t)return e=new Ht(t),++this._modelCount,e;throw new Error("Unknown error")}},{key:"deleteModel",value:function(e){null!=e&&--this._modelCount}},{key:"release",value:function(){this._moc._release(),this._moc=void 0}}],[{key:"create",value:function(t){var i=Live2DCubismCore.Moc.fromArrayBuffer(t);if(i)return new e(i);throw new Error("Unknown error")}}]),e}(),Jt=function(e){return e[e.CubismPhysicsTargetType_Parameter=0]="CubismPhysicsTargetType_Parameter",e}(Jt||{}),Qt=function(e){return e[e.CubismPhysicsSource_X=0]="CubismPhysicsSource_X",e[e.CubismPhysicsSource_Y=1]="CubismPhysicsSource_Y",e[e.CubismPhysicsSource_Angle=2]="CubismPhysicsSource_Angle",e}(Qt||{}),Kt=(0,u.Z)((function e(){(0,o.Z)(this,e),this.initialPosition=new Ie(0,0),this.position=new Ie(0,0),this.lastPosition=new Ie(0,0),this.lastGravity=new Ie(0,0),this.force=new Ie(0,0),this.velocity=new Ie(0,0)})),$t=(0,u.Z)((function e(){(0,o.Z)(this,e),this.normalizationPosition={},this.normalizationAngle={}})),ei=(0,u.Z)((function e(){(0,o.Z)(this,e),this.source={}})),ti=(0,u.Z)((function e(){(0,o.Z)(this,e),this.destination={},this.translationScale=new Ie(0,0)})),ii=(0,u.Z)((function e(){(0,o.Z)(this,e),this.settings=[],this.inputs=[],this.outputs=[],this.particles=[],this.gravity=new Ie(0,0),this.wind=new Ie(0,0)})),ri=function(){function e(t){(0,o.Z)(this,e),this._json=t}return(0,u.Z)(e,[{key:"release",value:function(){this._json=void 0}},{key:"getGravity",value:function(){var e=new Ie(0,0);return e.x=this._json.Meta.EffectiveForces.Gravity.X,e.y=this._json.Meta.EffectiveForces.Gravity.Y,e}},{key:"getWind",value:function(){var e=new Ie(0,0);return e.x=this._json.Meta.EffectiveForces.Wind.X,e.y=this._json.Meta.EffectiveForces.Wind.Y,e}},{key:"getSubRigCount",value:function(){return this._json.Meta.PhysicsSettingCount}},{key:"getTotalInputCount",value:function(){return this._json.Meta.TotalInputCount}},{key:"getTotalOutputCount",value:function(){return this._json.Meta.TotalOutputCount}},{key:"getVertexCount",value:function(){return this._json.Meta.VertexCount}},{key:"getNormalizationPositionMinimumValue",value:function(e){return this._json.PhysicsSettings[e].Normalization.Position.Minimum}},{key:"getNormalizationPositionMaximumValue",value:function(e){return this._json.PhysicsSettings[e].Normalization.Position.Maximum}},{key:"getNormalizationPositionDefaultValue",value:function(e){return this._json.PhysicsSettings[e].Normalization.Position.Default}},{key:"getNormalizationAngleMinimumValue",value:function(e){return this._json.PhysicsSettings[e].Normalization.Angle.Minimum}},{key:"getNormalizationAngleMaximumValue",value:function(e){return this._json.PhysicsSettings[e].Normalization.Angle.Maximum}},{key:"getNormalizationAngleDefaultValue",value:function(e){return this._json.PhysicsSettings[e].Normalization.Angle.Default}},{key:"getInputCount",value:function(e){return this._json.PhysicsSettings[e].Input.length}},{key:"getInputWeight",value:function(e,t){return this._json.PhysicsSettings[e].Input[t].Weight}},{key:"getInputReflect",value:function(e,t){return this._json.PhysicsSettings[e].Input[t].Reflect}},{key:"getInputType",value:function(e,t){return this._json.PhysicsSettings[e].Input[t].Type}},{key:"getInputSourceId",value:function(e,t){return this._json.PhysicsSettings[e].Input[t].Source.Id}},{key:"getOutputCount",value:function(e){return this._json.PhysicsSettings[e].Output.length}},{key:"getOutputVertexIndex",value:function(e,t){return this._json.PhysicsSettings[e].Output[t].VertexIndex}},{key:"getOutputAngleScale",value:function(e,t){return this._json.PhysicsSettings[e].Output[t].Scale}},{key:"getOutputWeight",value:function(e,t){return this._json.PhysicsSettings[e].Output[t].Weight}},{key:"getOutputDestinationId",value:function(e,t){return this._json.PhysicsSettings[e].Output[t].Destination.Id}},{key:"getOutputType",value:function(e,t){return this._json.PhysicsSettings[e].Output[t].Type}},{key:"getOutputReflect",value:function(e,t){return this._json.PhysicsSettings[e].Output[t].Reflect}},{key:"getParticleCount",value:function(e){return this._json.PhysicsSettings[e].Vertices.length}},{key:"getParticleMobility",value:function(e,t){return this._json.PhysicsSettings[e].Vertices[t].Mobility}},{key:"getParticleDelay",value:function(e,t){return this._json.PhysicsSettings[e].Vertices[t].Delay}},{key:"getParticleAcceleration",value:function(e,t){return this._json.PhysicsSettings[e].Vertices[t].Acceleration}},{key:"getParticleRadius",value:function(e,t){return this._json.PhysicsSettings[e].Vertices[t].Radius}},{key:"getParticlePosition",value:function(e,t){var i=new Ie(0,0);return i.x=this._json.PhysicsSettings[e].Vertices[t].Position.X,i.y=this._json.PhysicsSettings[e].Vertices[t].Position.Y,i}}]),e}(),ni="Angle",ai=function(){function e(){(0,o.Z)(this,e),this._options=new si,this._options.gravity.y=-1,this._options.gravity.x=0,this._options.wind.x=0,this._options.wind.y=0}return(0,u.Z)(e,[{key:"evaluate",value:function(e,t){var i,r,n,a,s,o,u,l,h,c,d,f,g=new Ie;h=e.getModel().parameters.values,c=e.getModel().parameters.maximumValues,d=e.getModel().parameters.minimumValues,f=e.getModel().parameters.defaultValues;for(var m=0;m<this._physicsRig.subRigCount;++m){i={angle:0},g.x=0,g.y=0,s=this._physicsRig.settings[m],o=this._physicsRig.inputs.slice(s.baseInputIndex),u=this._physicsRig.outputs.slice(s.baseOutputIndex),l=this._physicsRig.particles.slice(s.baseParticleIndex);for(var p=0;p<s.inputCount;++p)r=o[p].weight/100,-1==o[p].sourceParameterIndex&&(o[p].sourceParameterIndex=e.getParameterIndex(o[p].source.id)),o[p].getNormalizedParameterValue(g,i,h[o[p].sourceParameterIndex],d[o[p].sourceParameterIndex],c[o[p].sourceParameterIndex],f[o[p].sourceParameterIndex],s.normalizationPosition,s.normalizationAngle,o[p].reflect,r);n=Te.degreesToRadian(-i.angle),g.x=g.x*Te.cos(n)-g.y*Te.sin(n),g.y=g.x*Te.sin(n)+g.y*Te.cos(n),vi(l,s.particleCount,g,i.angle,this._options.wind,.001*s.normalizationPosition.maximum,t,5);for(var v=0;v<s.outputCount;++v){var _=u[v].vertexIndex;if(_<1||_>=s.particleCount)break;-1==u[v].destinationParameterIndex&&(u[v].destinationParameterIndex=e.getParameterIndex(u[v].destination.id));var y=new Ie;y.x=l[_].position.x-l[_-1].position.x,y.y=l[_].position.y-l[_-1].position.y,a=u[v].getValue(y,l,_,u[v].reflect,this._options.gravity);var x=u[v].destinationParameterIndex,k=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(h.subarray(x))):h.slice(x);_i(k,d[x],c[x],a,u[v]);for(var M=x,b=0;M<h.length;M++,b++)h[M]=k[b]}}}},{key:"setOptions",value:function(e){this._options=e}},{key:"getOption",value:function(){return this._options}},{key:"release",value:function(){this._physicsRig=void 0}},{key:"parse",value:function(e){this._physicsRig=new ii;var t=new ri(e);this._physicsRig.gravity=t.getGravity(),this._physicsRig.wind=t.getWind(),this._physicsRig.subRigCount=t.getSubRigCount();for(var i=0,r=0,n=0,a=0;a<this._physicsRig.subRigCount;++a){var s=new $t;s.normalizationPosition.minimum=t.getNormalizationPositionMinimumValue(a),s.normalizationPosition.maximum=t.getNormalizationPositionMaximumValue(a),s.normalizationPosition.defalut=t.getNormalizationPositionDefaultValue(a),s.normalizationAngle.minimum=t.getNormalizationAngleMinimumValue(a),s.normalizationAngle.maximum=t.getNormalizationAngleMaximumValue(a),s.normalizationAngle.defalut=t.getNormalizationAngleDefaultValue(a),s.inputCount=t.getInputCount(a),s.baseInputIndex=i,i+=s.inputCount;for(var o=0;o<s.inputCount;++o){var u=new ei;switch(u.sourceParameterIndex=-1,u.weight=t.getInputWeight(a,o),u.reflect=t.getInputReflect(a,o),t.getInputType(a,o)){case"X":u.type=Qt.CubismPhysicsSource_X,u.getNormalizedParameterValue=oi;break;case"Y":u.type=Qt.CubismPhysicsSource_Y,u.getNormalizedParameterValue=ui;break;case ni:u.type=Qt.CubismPhysicsSource_Angle,u.getNormalizedParameterValue=li}u.source.targetType=Jt.CubismPhysicsTargetType_Parameter,u.source.id=t.getInputSourceId(a,o),this._physicsRig.inputs.push(u)}s.outputCount=t.getOutputCount(a),s.baseOutputIndex=r,r+=s.outputCount;for(var l=0;l<s.outputCount;++l){var h=new ti;switch(h.destinationParameterIndex=-1,h.vertexIndex=t.getOutputVertexIndex(a,l),h.angleScale=t.getOutputAngleScale(a,l),h.weight=t.getOutputWeight(a,l),h.destination.targetType=Jt.CubismPhysicsTargetType_Parameter,h.destination.id=t.getOutputDestinationId(a,l),t.getOutputType(a,l)){case"X":h.type=Qt.CubismPhysicsSource_X,h.getValue=hi,h.getScale=gi;break;case"Y":h.type=Qt.CubismPhysicsSource_Y,h.getValue=ci,h.getScale=mi;break;case ni:h.type=Qt.CubismPhysicsSource_Angle,h.getValue=di,h.getScale=pi}h.reflect=t.getOutputReflect(a,l),this._physicsRig.outputs.push(h)}s.particleCount=t.getParticleCount(a),s.baseParticleIndex=n,n+=s.particleCount;for(var c=0;c<s.particleCount;++c){var d=new Kt;d.mobility=t.getParticleMobility(a,c),d.delay=t.getParticleDelay(a,c),d.acceleration=t.getParticleAcceleration(a,c),d.radius=t.getParticleRadius(a,c),d.position=t.getParticlePosition(a,c),this._physicsRig.particles.push(d)}this._physicsRig.settings.push(s)}this.initialize(),t.release()}},{key:"initialize",value:function(){for(var e,t,i,r=0;r<this._physicsRig.subRigCount;++r){t=this._physicsRig.settings[r],(e=this._physicsRig.particles.slice(t.baseParticleIndex))[0].initialPosition=new Ie(0,0),e[0].lastPosition=new Ie(e[0].initialPosition.x,e[0].initialPosition.y),e[0].lastGravity=new Ie(0,-1),e[0].lastGravity.y*=-1,e[0].velocity=new Ie(0,0),e[0].force=new Ie(0,0);for(var n=1;n<t.particleCount;++n)(i=new Ie(0,0)).y=e[n].radius,e[n].initialPosition=new Ie(e[n-1].initialPosition.x+i.x,e[n-1].initialPosition.y+i.y),e[n].position=new Ie(e[n].initialPosition.x,e[n].initialPosition.y),e[n].lastPosition=new Ie(e[n].initialPosition.x,e[n].initialPosition.y),e[n].lastGravity=new Ie(0,-1),e[n].lastGravity.y*=-1,e[n].velocity=new Ie(0,0),e[n].force=new Ie(0,0)}}}],[{key:"create",value:function(t){var i=new e;return i.parse(t),i._physicsRig.gravity.y=0,i}}]),e}(),si=(0,u.Z)((function e(){(0,o.Z)(this,e),this.gravity=new Ie(0,0),this.wind=new Ie(0,0)}));function oi(e,t,i,r,n,a,s,o,u,l){e.x+=yi(i,r,n,a,s.minimum,s.maximum,s.defalut,u)*l}function ui(e,t,i,r,n,a,s,o,u,l){e.y+=yi(i,r,n,a,s.minimum,s.maximum,s.defalut,u)*l}function li(e,t,i,r,n,a,s,o,u,l){t.angle+=yi(i,r,n,a,o.minimum,o.maximum,o.defalut,u)*l}function hi(e,t,i,r,n){var a=e.x;return r&&(a*=-1),a}function ci(e,t,i,r,n){var a=e.y;return r&&(a*=-1),a}function di(e,t,i,r,n){var a;return n=i>=2?t[i-1].position.substract(t[i-2].position):n.multiplyByScaler(-1),a=Te.directionToRadian(n,e),r&&(a*=-1),a}function fi(e,t){return Math.min(e,t)+function(e,t){return Math.abs(Math.max(e,t)-Math.min(e,t))}(e,t)/2}function gi(e,t){return e.x}function mi(e,t){return e.y}function pi(e,t){return t}function vi(e,t,i,r,n,a,s,o){var u,l,h,c,d=new Ie(0,0),f=new Ie(0,0),g=new Ie(0,0),m=new Ie(0,0);e[0].position=new Ie(i.x,i.y),u=Te.degreesToRadian(r),(c=Te.radianToDirection(u)).normalize();for(var p=1;p<t;++p)e[p].force=c.multiplyByScaler(e[p].acceleration).add(n),e[p].lastPosition=new Ie(e[p].position.x,e[p].position.y),l=e[p].delay*s*30,d=e[p].position.substract(e[p-1].position),h=Te.directionToRadian(e[p].lastGravity,c)/o,d.x=Te.cos(h)*d.x-d.y*Te.sin(h),d.y=Te.sin(h)*d.x+d.y*Te.cos(h),e[p].position=e[p-1].position.add(d),f=e[p].velocity.multiplyByScaler(l),g=e[p].force.multiplyByScaler(l).multiplyByScaler(l),e[p].position=e[p].position.add(f).add(g),(m=e[p].position.substract(e[p-1].position)).normalize(),e[p].position=e[p-1].position.add(m.multiplyByScaler(e[p].radius)),Te.abs(e[p].position.x)<a&&(e[p].position.x=0),0!=l&&(e[p].velocity=e[p].position.substract(e[p].lastPosition),e[p].velocity=e[p].velocity.divisionByScalar(l),e[p].velocity=e[p].velocity.multiplyByScaler(e[p].mobility)),e[p].force=new Ie(0,0),e[p].lastGravity=new Ie(c.x,c.y)}function _i(e,t,i,r,n){var a,s;(a=r*n.getScale(n.translationScale,n.angleScale))<t?(a<n.valueBelowMinimum&&(n.valueBelowMinimum=a),a=t):a>i&&(a>n.valueExceededMaximum&&(n.valueExceededMaximum=a),a=i),(s=n.weight/100)>=1||(a=e[0]*(1-s)+a*s),e[0]=a}function yi(e,t,i,r,n,a,s,o){var u=0,l=Te.max(i,t);l<e&&(e=l);var h=Te.min(i,t);h>e&&(e=h);var c=Te.min(n,a),d=Te.max(n,a),f=s,g=fi(h,l),m=e-g;switch(Math.sign(m)){case 1:var p=l-g;0!=p&&(u=m*((d-f)/p),u+=f);break;case-1:var v=h-g;0!=v&&(u=m*((c-f)/v),u+=f);break;case 0:u=f}return o?u:-1*u}function xi(){var e;null==(e=this.__moc)||e.release()}ie.registerRuntime({version:4,ready:function(){return Ne.isStarted()?Promise.resolve():(null!=jt||(jt=new Promise((function(e,t){!function i(){try{n=Object.assign({logFunction:console.log,loggingLevel:Ve.LogLevel_Verbose},n),Ne.startUp(n),Ne.initialize(),e()}catch(a){if(--Xt<0){var r=new Error("Failed to start up Cubism 4 framework.");return r.cause=a,void t(r)}C("Cubism4","Startup failed, retrying 10ms later..."),setTimeout(i,10)}var n}()}))),jt)},test:function(e){return e instanceof tt||tt.isValidJSON(e)},isValidMoc:function(e){if(e.byteLength<4)return!1;var t=new Int8Array(e,0,4);return"MOC3"===String.fromCharCode.apply(String,(0,v.Z)(t))},createModelSettings:function(e){return new tt(e)},createCoreModel:function(e){var t=qt.create(e);try{var i=t.createModel();return i.__moc=t,i}catch(r){try{t.release()}catch(n){}throw r}},createInternalModel:function(e,t,i){var r=new zt(e,t,i),n=e;return n.__moc&&(r.__moc=n.__moc,delete n.__moc,r.once("destroy",xi)),r},createPhysics:function(e,t){return ai.create(t)},createPose:function(e,t){return Wt.create(t)}});var ki=i(5587),Mi=i(8135);function bi(){return(bi=(0,h.Z)((0,l.Z)().mark((function e(t,i){var r,n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.originalSource,n=[],e.abrupt("return",(null==t.source.expressions&&(Object.values(r).filter((function(e,t,i){return e.name.endsWith(".exp3.json")})).forEach((function(e,t){n.push({Name:"exp_"+t,File:e.name})})),t.source.expressions=n),null==t.source.motions&&(n=[],Object.values(r).filter((function(e,t,i){return e.name.endsWith(".motion3.json")})).forEach((function(e,t){n.push({Name:"motion_"+t,File:e.name})})),t.source.motions=n),ie.jsonToSettings(t,i)));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}ie.live2DModelMiddlewares[ie.live2DModelMiddlewares.indexOf(ie.jsonToSettings)]=function(e,t){return bi.apply(this,arguments)},ie.live2DModelMiddlewares[ie.live2DModelMiddlewares.indexOf(ie.createInternalModel)]=function(e,t){return Ci.apply(this,arguments)};var Pi=function(){var e=(0,h.Z)((0,l.Z)().mark((function e(t,i){var r,n;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(Array.isArray(t.source)&&t.source[0]instanceof File)){e.next=15;break}if(r=t.source,n=r.settings){e.next=8;break}return e.next=5,de.createSettings(r);case 5:n=e.sent,e.next=10;break;case 8:if(n._objectURL){e.next=10;break}throw new Error('"_objectURL" must be specified in ModelSettings');case 10:return e.next=12,de.upload(r,n);case 12:n.resolveURL=function(e){return null!=n&&n.textures.includes(e)?e:de.resolveURL(this._objectURL,e)},t.source=n,t.live2dModel.once("modelLoaded",(function(e){e.once("destroy",(function(){var e=this.settings._objectURL;if(URL.revokeObjectURL(e),de.filesMap[e])for(var t=0,i=Object.values(de.filesMap[e]);t<i.length;t++){var r=i[t];URL.revokeObjectURL(r)}delete de.filesMap[e]}))}));case 15:return e.abrupt("return",i());case 16:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}(),Si=function(){var e=(0,h.Z)((0,l.Z)().mark((function e(t,i){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(t.originalSource=t.source,Pi(t,i)));case 1:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}();function Ci(){return(Ci=(0,h.Z)((0,l.Z)().mark((function e(t,i){return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(t.settings.originalSource=t.originalSource,ie.createInternalModel(t,i)));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}ie.live2DModelMiddlewares[ie.live2DModelMiddlewares.indexOf(de.factory)]=Si;var wi=function(){var e=(0,h.Z)((0,l.Z)().mark((function e(t,i){var r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.settings.originalSource.find((function(e){return e.webkitRelativePath.endsWith(t.url)})),"json"!==t.type){e.next=12;break}return e.t1=JSON,e.next=5,r.text();case 5:return e.t2=e.sent,e.next=8,e.t1.parse.call(e.t1,e.t2);case 8:t.result=e.sent,e.t0=i(),e.next=21;break;case 12:if("arraybuffer"!==t.type){e.next=19;break}return e.next=15,null==r?void 0:r.arrayBuffer();case 15:t.result=e.sent,e.t3=i(),e.next=20;break;case 19:e.t3=new Promise((function(e,i){z.createXHR(t.target,t.settings?t.settings.resolveURL(t.url):t.url,t.type,(function(i){t.result=i,e()}),i).send()}));case 20:e.t0=e.t3;case 21:return e.abrupt("return",e.t0);case 22:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}();W.middlewares[W.middlewares.indexOf(z.loader)]=wi;var Ii=function(){var e=(0,h.Z)((0,l.Z)().mark((function e(t,i){var r,n,a;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.settings){e.next=15;break}return r=t.live2dModel,n=t.originalSource,a=t.settings.textures.map(function(){var e=(0,h.Z)((0,l.Z)().mark((function e(i){var r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.settings.resolveURL(i),r=n.find((function(e){return e.webkitRelativePath.endsWith(i)})),e.abrupt("return",Mi.Texture.fromURL(URL.createObjectURL(r)));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=4,i();case 4:if(!t.internalModel){e.next=8;break}r.internalModel=t.internalModel,r.emit("modelLoaded",t.internalModel),e.next=9;break;case 8:throw new TypeError("Missing internal model.");case 9:return e.next=11,Promise.all(a);case 11:r.textures=e.sent,r.emit("textureLoaded",r.textures),e.next=16;break;case 15:throw new TypeError("Missing settings.");case 16:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}();ie.live2DModelMiddlewares[ie.live2DModelMiddlewares.indexOf(ie.setupEssentials)]=Ii;var Li=function(){function e(t,i){(0,o.Z)(this,e),this.whitelist=[],this.blacklist=[],t&&(this.whitelist=t),i&&(this.blacklist=i)}return(0,u.Z)(e,[{key:"checkFile",value:function(e){if(this.blacklist.length>0)for(var t=0;t<this.blacklist.length;t++)if(e.startsWith(this.blacklist[t])||e.endsWith(this.blacklist[t]))return!1;if(this.whitelist.length>0){for(var i=0;i<this.whitelist.length;i++)if(e.endsWith(this.whitelist[i]))return!0;return!1}return!0}},{key:"filterFiles",value:function(e){var t=this;return e.filter((function(e){return t.checkFile(e.name)}))}}]),e}();function Ti(e){var t=e;return t.forEach((function(e){var t=e.path;t||(t=e.webkitRelativePath),t||(t=e.name),t.startsWith("/")&&(t=t.slice(1)),Object.defineProperty(e,"webkitRelativePath",{value:t})})),t}function Ei(e){var t=e[0].name||e[0].webkitRelativePath,i="";if(i=t.endsWith(".zip")?".zip":"/",""===(t=t.slice(0,t.indexOf(i))))throw new Error("Model file name is empty");return t}var Fi=function(){function e(){(0,o.Z)(this,e),this.filter=new Li([],["vtube.json","items_pinned_to_model.json",".cmo3","__MACOSX"])}return(0,u.Z)(e,[{key:"matchIcon",value:function(e){return e.toLowerCase().endsWith("icon.png")||e.toLowerCase().endsWith("icon.jpeg")||e.toLowerCase().endsWith("icon.jpg")||e.toLowerCase().endsWith("icon.webp")||!e.substring(e.indexOf("/")+1,e.length).includes("/")&&e.toLowerCase().endsWith(".png")}},{key:"loadIconFromZip",value:function(){var e=(0,h.Z)((0,l.Z)().mark((function e(t){var i,r,n,a,s,o,u,h,c=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ki.loadAsync(t);case 2:i=e.sent,r=[],n=[],i.forEach((function(e,t){!t.dir&&c.filter.checkFile(e)&&r.push(e)})),r=[r.find((function(e){return c.matchIcon(e)}))],a=0;case 7:if(!(a<r.length)){e.next=19;break}if(s=r[a],o=i.file(s)){e.next=11;break}return e.abrupt("continue",16);case 11:return u=s.slice(s.indexOf("/")+1),e.next=14,o.async("blob");case 14:h=e.sent,n.push(new File([h],u));case 16:a++,e.next=7;break;case 19:if(!(n.length>0)){e.next=21;break}return e.abrupt("return",n[0]);case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"loadFilesFromZip",value:function(){var e=(0,h.Z)((0,l.Z)().mark((function e(t){var i,r,n,a,s,o,u,h=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ki.loadAsync(t);case 2:i=e.sent,r=[],n=[],i.forEach((function(e,t){!t.dir&&h.filter.checkFile(e)&&r.push(e)})),a=0;case 7:if(!(a<r.length)){e.next=19;break}if(s=r[a],o=i.file(s)){e.next=11;break}return e.abrupt("continue",16);case 11:return s.startsWith("/")&&(s=s.slice(1)),e.next=14,o.async("blob");case 14:u=e.sent,n.push(new File([u],s));case 16:a++,e.next=7;break;case 19:if(!n){e.next=21;break}return e.abrupt("return",n);case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"loadIcon",value:function(){var e=(0,h.Z)((0,l.Z)().mark((function e(t){var i,r=this;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.find((function(e){return r.matchIcon(e.name)})),e.t0=!i&&1===t.length&&t[0].name.endsWith(".zip"),!e.t0){e.next=6;break}return e.next=5,this.loadIconFromZip(t[0]);case 5:i=e.sent;case 6:return e.abrupt("return",i?URL.createObjectURL(i):void 0);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"loadAvatar",value:function(){var e=(0,h.Z)((0,l.Z)().mark((function e(t,i){var r;return(0,l.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,he.from(t,{motionPreload:Z.ALL});case 2:return r=e.sent,e.abrupt("return",(r.scale.set(.2,.2),r.anchor.set(.5,.5),r.autoInteract=!1,r));case 4:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"checkIfSupported",value:function(e){return 1===e.length?e[0].name.endsWith(".zip")||e[0].name.endsWith("live2d"):void 0!==e.find((function(e){return e.name.endsWith(".model3.json")}))}},{key:"filterFiles",value:function(e){var t=this.filter.filterFiles(e);return t.map((function(e){var t=e.path;t||(t=e.webkitRelativePath),t||(t=e.name),t.startsWith("/")&&(t=t.slice(1)),Object.defineProperty(e,"webkitRelativePath",{value:t})})),t}},{key:"calFilesSizes",value:function(e){var t=this.filter.filterFiles(e),i=0;return t.map((function(e){i+=e.size})),i}}]),e}()}}]);
//# sourceMappingURL=315.54eea493.chunk.js.map